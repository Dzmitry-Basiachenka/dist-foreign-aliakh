<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="IUsageArchiveMapper">

    <resultMap id="archivedUsageResultMap" type="Usage" extends="IUsageMapper.usageResultMap">
        <result property="id" column="df_usage_archive_uid"/>
    </resultMap>

    <resultMap id="paidUsageResultMap" type="PaidUsage" extends="IUsageMapper.usageResultMap">
        <result property="rroAccountNumber" column="rro_account_number"/>
        <result property="checkNumber" column="check_number"/>
        <result property="checkDate" column="check_date"/>
        <result property="cccEventId" column="ccc_event_id"/>
        <result property="distributionName" column="distribution_name"/>
        <result property="distributionDate" column="distribution_date"/>
        <result property="periodEndDate" column="period_end_date"/>
        <result property="lmDetailId" column="lm_detail_id"/>
    </resultMap>

    <sql id="payeeColumns">
        service_fee,
        service_fee_amount,
        net_amount,
        payee_account_number,
        is_rh_participating_flag
    </sql>

    <insert id="insert" parameterType="Usage">
        insert into ${schema}.df_usage_archive(
            df_usage_archive_uid,
            <include refid="IUsageMapper.usageColumns"/>,
            <include refid="payeeColumns"/>,
            <include refid="StoredEntityMapper.additionalColumns"/>)
        values(
            #{id},
            #{batchId},
            #{scenarioId},
            #{wrWrkInst},
            #{workTitle},
            #{systemTitle},
            #{rightsholder.accountNumber},
            #{status},
            #{productFamily},
            #{article},
            #{standardNumber},
            #{publisher},
            #{publicationDate},
            #{market},
            #{marketPeriodFrom},
            #{marketPeriodTo},
            #{author},
            #{numberOfCopies},
            #{reportedValue},
            #{grossAmount},
            #{serviceFee},
            #{serviceFeeAmount},
            #{netAmount},
            #{payee.accountNumber},
            #{rhParticipating},
            <include refid="StoredEntityMapper.insert"/>
        )
    </insert>

    <select id="findRightsholderTotalsHolderCountByScenarioId" parameterType="map" resultType="int">
        select count(1)
        from (
            select distinct rh_account_number
            from ${schema}.df_usage_archive
            where df_scenario_uid = #{scenarioId}) u
            left join ${schema}.df_rightsholder r on u.rh_account_number = r.rh_account_number
        <if test="null != searchValue">
            where <include refid="IUsageMapper.searchWhereClause"/>
        </if>
    </select>

    <select id="findRightsholderTotalsHoldersByScenarioId" parameterType="map" resultMap="IUsageMapper.rightsholderTotalsHolderResultMap">
        select
            r.name rh_name,
            u.rh_account_number,
            p.name payee_name,
            u.payee_account_number,
            u.gross_total,
            u.service_fee_total,
            u.net_total,
            u.service_fee
        from (
            select
                rh_account_number,
                payee_account_number,
                sum(gross_amount) gross_total,
                sum(service_fee_amount) service_fee_total,
                sum(net_amount) net_total,
                service_fee
            from ${schema}.df_usage_archive
            where df_scenario_uid = #{scenarioId}
            group by rh_account_number, payee_account_number, service_fee) u
        left join ${schema}.df_rightsholder r on u.rh_account_number = r.rh_account_number
        left join ${schema}.df_rightsholder p on u.payee_account_number = p.rh_account_number
        <if test="null != searchValue">
            where <include refid="IUsageMapper.searchWhereClause"/>
        </if>
        <include refid="IUsageMapper.rightsholderTotalHoldersOrderBy"/>
        <if test="null != pageable">
            limit #{pageable.limit}
            offset #{pageable.offset}
        </if>
    </select>

    <select id="findByScenarioIdAndRhAccountNumber" parameterType="map" resultMap="IUsageMapper.usageDtoResultMap">
        select
            u.df_usage_archive_uid df_usage_uid,
            <include refid="IUsageMapper.usageDtoColumns"/>,
            u.check_number,
            u.check_date,
            u.ccc_event_id,
            u.distribution_name,
            u.distribution_date,
            u.period_end_date
        from ${schema}.df_usage_archive u
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        left join ${schema}.df_rightsholder rro on rro.rh_account_number = ub.rro_account_number
        left join ${schema}.df_rightsholder p on p.rh_account_number = u.payee_account_number
        where u.df_scenario_uid = #{scenarioId} and u.rh_account_number = #{accountNumber}
        <if test="null != searchValue">
            and (
            <include refid="IUsageMapper.drillDownSearchWhereClause">
                <property name="detail_uid" value="u.df_usage_archive_uid"/>
            </include>
            )
        </if>
        order by
        <choose>
            <when test="null != sort">
                <include refid="IUsageMapper.chooseSortProperty">
                    <property name="detail_uid" value="u.df_usage_archive_uid"/>
                </include>
            </when>
            <otherwise>
                df_usage_archive_uid
            </otherwise>
        </choose>
        <include refid="IUsageMapper.ifPageable"/>
    </select>

    <select id="findCountByScenarioIdAndRhAccountNumber" parameterType="map" resultType="int">
        select count(1)
        from ${schema}.df_usage_archive u
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_rightsholder rro on ub.rro_account_number = rro.rh_account_number
        where df_scenario_uid = #{scenarioId} and u.rh_account_number = #{accountNumber}
        <if test="null != searchValue">
            and (
            <include refid="IUsageMapper.drillDownSearchWhereClause">
                <property name="detail_uid" value="u.df_usage_archive_uid"/>
            </include>
            )
        </if>
    </select>

    <select id="findDtoByScenarioId" resultMap="IUsageMapper.usageDtoResultMap">
        select
            u.df_usage_archive_uid df_usage_uid,
            <include refid="IUsageMapper.usageDtoColumns"/>
        from ${schema}.df_usage_archive u
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        left join ${schema}.df_rightsholder rro on rro.rh_account_number = ub.rro_account_number
        left join ${schema}.df_rightsholder p on p.rh_account_number = u.payee_account_number
        where df_scenario_uid = #{scenarioId}
        order by u.rh_account_number
    </select>

    <update id="updatePaidInfo" parameterType="PaidUsage">
        update ${schema}.df_usage_archive
        set
            payee_account_number = #{payee.accountNumber},
            check_number = #{checkNumber},
            check_date = #{checkDate},
            status_ind = #{status},
            ccc_event_id = #{cccEventId},
            distribution_name = #{distributionName},
            distribution_date = #{distributionDate},
            period_end_date = #{periodEndDate},
            lm_detail_id = #{lmDetailId},
            <include refid="StoredEntityMapper.update"/>
        where df_usage_archive_uid = #{id}
    </update>

    <update id="updateStatusById" parameterType="map">
        update ${schema}.df_usage_archive
        set status_ind = #{status},
            <include refid="StoredEntityMapper.update"/>
        where df_usage_archive_uid = #{usageId}
    </update>

    <select id="findByIdAndStatus" resultMap="paidUsageResultMap" parameterType="map">
        select
            u.df_usage_archive_uid df_usage_uid,
            u.rh_account_number,
            u.product_family,
            u.payee_account_number,
            u.wr_wrk_inst,
            u.work_title,
            u.system_title,
            u.article,
            u.author,
            u.publication_date,
            u.number_of_copies,
            u.market,
            u.market_period_from,
            u.market_period_to,
            u.net_amount,
            u.service_fee_amount,
            u.gross_amount,
            u.check_number,
            u.check_date,
            u.ccc_event_id,
            u.distribution_name,
            u.distribution_date,
            u.period_end_date,
            u.lm_detail_id,
            u.created_datetime,
            ub.rro_account_number
        from ${schema}.df_usage_archive u
        left join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        where u.status_ind = #{status}
            and u.df_usage_archive_uid in
            <foreach collection="usageIds" item="usageId" separator="," open="(" close=")">
                #{usageId}
            </foreach>
    </select>

    <select id="findPaidIds" parameterType="UsageStatusEnum" resultType="string">
        select df_usage_archive_uid
        from ${schema}.df_usage_archive
        where status_ind = #{status}
    </select>

    <select id="findUsageInformationById" resultMap="archivedUsageResultMap" parameterType="map">
        select
            df_usage_archive_uid,
            <include refid="IUsageMapper.usageColumns"/>,
            <include refid="payeeColumns"/>
        from ${schema}.df_usage_archive u
        where u.df_usage_archive_uid in
            <foreach collection="usageIds" item="usageId" separator="," open="(" close=")">
                #{usageId}
            </foreach>
    </select>

    <insert id="insertPaid" parameterType="PaidUsage">
        insert into ${schema}.df_usage_archive(
            df_usage_archive_uid,
            <include refid="IUsageMapper.usageColumns"/>,
            <include refid="payeeColumns"/>,
            check_number,
            check_date,
            ccc_event_id,
            distribution_name,
            distribution_date,
            period_end_date,
            lm_detail_id,
            <include refid="StoredEntityMapper.additionalColumns"/>)
        values(
            #{id},
            #{batchId},
            #{scenarioId},
            #{wrWrkInst},
            #{workTitle},
            #{systemTitle},
            #{rightsholder.accountNumber},
            #{status},
            #{productFamily},
            #{article},
            #{standardNumber},
            #{publisher},
            #{publicationDate},
            #{market},
            #{marketPeriodFrom},
            #{marketPeriodTo},
            #{author},
            #{numberOfCopies},
            #{reportedValue},
            #{grossAmount},
            #{serviceFee},
            #{serviceFeeAmount},
            #{netAmount},
            #{payee.accountNumber},
            #{rhParticipating},
            #{checkNumber},
            #{checkDate},
            #{cccEventId},
            #{distributionName},
            #{distributionDate},
            #{periodEndDate},
            #{lmDetailId},
            <include refid="StoredEntityMapper.insert"/>
        )
    </insert>
</mapper>
