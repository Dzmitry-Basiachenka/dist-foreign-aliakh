<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="IAaclFundPoolMapper">

    <resultMap id="fundPoolResultMap" type="FundPool" extends="StoredEntityMapper.storedEntityResult">
        <result property="id" column="df_fund_pool_uid"/>
        <result property="productFamily" column="product_family"/>
        <result property="name" column="name"/>
        <result property="totalAmount" column="total_amount"/>
    </resultMap>

    <resultMap id="aaclFundPoolDetailResultMap" type="FundPoolDetail" extends="StoredEntityMapper.storedEntityResult">
        <result property="id" column="df_fund_pool_detail_uid"/>
        <result property="grossAmount" column="gross_amount"/>
        <result property="aggregateLicenseeClass.id" column="aggregate_licensee_class_id" javaType="java.lang.Integer"/>
        <result property="aggregateLicenseeClass.name" column="aggregate_licensee_class_name"/>
    </resultMap>

    <select id="findAggregateLicenseeClassIds" resultType="int">
        select aggregate_licensee_class_id
        from ${schema}.df_aggregate_licensee_class
    </select>

    <select id="findAll" resultMap="fundPoolResultMap" parameterType="string">
        select
            pf.df_fund_pool_uid,
            pf.product_family,
            pf.name,
            sum(coalesce(fpd.gross_amount, 0)) total_amount,
            pf.created_datetime,
            pf.updated_datetime,
            pf.created_by_user,
            pf.updated_by_user,
            pf.record_version
        from ${schema}.df_fund_pool pf
        left join ${schema}.df_fund_pool_detail fpd on fpd.df_fund_pool_uid = pf.df_fund_pool_uid
        where pf.product_family = #{productFamily}
        group by pf.df_fund_pool_uid
        order by pf.updated_datetime desc
    </select>

    <select id="findDetailsByFundPoolId" parameterType="string" resultMap="aaclFundPoolDetailResultMap">
        select
            fpd.df_fund_pool_detail_uid,
            alc.aggregate_licensee_class_id,
            alc.aggregate_licensee_class_name,
            fpd.gross_amount,
            fpd.created_datetime,
            fpd.updated_datetime,
            fpd.created_by_user,
            fpd.updated_by_user,
            fpd.record_version
        from ${schema}.df_fund_pool_detail fpd
        join ${schema}.df_aggregate_licensee_class alc
            on alc.aggregate_licensee_class_id = fpd.df_aggregate_licensee_class_id
        where fpd.df_fund_pool_uid = #{fundPoolId}
        order by alc.aggregate_licensee_class_id
    </select>

    <delete id="deleteById" parameterType="string">
        delete from ${schema}.df_fund_pool
        where df_fund_pool_uid = #{fundPoolId}
    </delete>

    <delete id="deleteDetailsByFundPoolId" parameterType="string">
        delete from ${schema}.df_fund_pool_detail
        where df_fund_pool_uid = #{fundPoolId}
    </delete>

    <insert id="insertDetail" parameterType="FundPoolDetail">
        insert into ${schema}.df_fund_pool_detail (
            df_fund_pool_detail_uid,
            df_fund_pool_uid,
            df_aggregate_licensee_class_id,
            gross_amount,
            <include refid="StoredEntityMapper.additionalColumns"/>
        ) values (
            #{id},
            #{fundPoolId},
            #{aggregateLicenseeClass.id},
            #{grossAmount},
            <include refid="StoredEntityMapper.insert"/>
        )
    </insert>
</mapper>
