<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="IUsageMapper">

    <resultMap id="usageDtoResultMap" type="UsageDto" extends="StoredEntityMapper.storedEntityResult">
        <result property="id" column="df_usage_uid"/>
        <result property="wrWrkInst" column="wr_wrk_inst"/>
        <result property="workTitle" column="work_title"/>
        <result property="systemTitle" column="system_title"/>
        <result property="rhAccountNumber" column="rh_account_number"/>
        <result property="rhName" column="rh_name"/>
        <result property="status" column="status_ind"/>
        <result property="productFamily" column="product_family"/>
        <result property="article" column="article"/>
        <result property="standardNumber" column="standard_number"/>
        <result property="standardNumberType" column="standard_number_type"/>
        <result property="publisher" column="publisher"/>
        <result property="publicationDate" column="publication_date"/>
        <result property="market" column="market"/>
        <result property="marketPeriodFrom" column="market_period_from"/>
        <result property="marketPeriodTo" column="market_period_to"/>
        <result property="author" column="author"/>
        <result property="numberOfCopies" column="number_of_copies"/>
        <result property="reportedValue" column="reported_value"/>
        <result property="grossAmount" column="gross_amount"/>
        <result property="batchGrossAmount" column="batch_gross_amount"/>
        <result property="batchName" column="batch_name"/>
        <result property="scenarioName" column="scenario_name"/>
        <result property="rroAccountNumber" column="rro_account_number"/>
        <result property="rroName" column="rro_name"/>
        <result property="paymentDate" column="payment_date"/>
        <result property="fiscalYear" column="fiscal_year"/>
        <result property="serviceFeeAmount" column="service_fee_amount"/>
        <result property="netAmount" column="net_amount"/>
        <result property="serviceFee" column="service_fee"/>
        <result property="payeeAccountNumber" column="payee_account_number"/>
        <result property="payeeName" column="payee_name"/>
        <result property="rhParticipating" column="is_rh_participating_flag"/>
        <result property="checkNumber" column="check_number"/>
        <result property="checkDate" column="check_date"/>
        <result property="cccEventId" column="ccc_event_id"/>
        <result property="distributionName" column="distribution_name"/>
        <result property="distributionDate" column="distribution_date"/>
        <result property="periodEndDate" column="period_end_date"/>
        <result property="comment" column="comment"/>
        <result property="aaclUsage.institution" column="institution"/>
        <result property="aaclUsage.usagePeriod" column="usage_period"/>
        <result property="aaclUsage.usageSource" column="usage_source"/>
        <result property="aaclUsage.numberOfPages" column="number_of_pages"/>
        <result property="aaclUsage.rightLimitation" column="right_limitation"/>
        <result property="aaclUsage.batchPeriodEndDate" column="batch_period_end_date"/>
    </resultMap>

    <resultMap id="usageAmountResultMap" type="Usage" extends="StoredEntityMapper.storedEntityResult">
        <result property="id" column="df_usage_uid"/>
        <result property="grossAmount" column="gross_amount"/>
        <result property="netAmount" column="net_amount"/>
        <result property="serviceFee" column="service_fee"/>
        <result property="serviceFeeAmount" column="service_fee_amount"/>
        <result property="reportedValue" column="reported_value"/>
        <result property="status" column="status_ind"/>
        <result property="productFamily" column="product_family"/>
        <result property="rightsholder.id" column="rh_id"/>
        <result property="rightsholder.accountNumber" column="rh_account_number"/>
        <result property="rightsholder.name" column="rh_name"/>
    </resultMap>

    <resultMap id="rightsholderTotalsHolderResultMap" type="RightsholderTotalsHolder">
        <result property="rightsholder.name" column="rh_name"/>
        <result property="rightsholder.accountNumber" column="rh_account_number"/>
        <result property="payee.name" column="payee_name"/>
        <result property="payee.accountNumber" column="payee_account_number"/>
        <result property="grossTotal" column="gross_total"/>
        <result property="serviceFeeTotal" column="service_fee_total"/>
        <result property="netTotal" column="net_total"/>
        <result property="serviceFee" column="service_fee"/>
    </resultMap>

    <resultMap id="usageResultMap" type="Usage" extends="usageAmountResultMap">
        <result property="batchId" column="df_usage_batch_uid"/>
        <result property="scenarioId" column="df_scenario_uid"/>
        <result property="fundPoolId" column="df_fund_pool_uid"/>
        <result property="wrWrkInst" column="wr_wrk_inst"/>
        <result property="workTitle" column="work_title"/>
        <result property="systemTitle" column="system_title"/>
        <result property="article" column="article"/>
        <result property="standardNumber" column="standard_number"/>
        <result property="standardNumberType" column="standard_number_type"/>
        <result property="publisher" column="publisher"/>
        <result property="publicationDate" column="publication_date"/>
        <result property="market" column="market"/>
        <result property="marketPeriodFrom" column="market_period_from"/>
        <result property="marketPeriodTo" column="market_period_to"/>
        <result property="author" column="author"/>
        <result property="numberOfCopies" column="number_of_copies"/>
        <result property="payee.id" column="payee_id"/>
        <result property="payee.accountNumber" column="payee_account_number"/>
        <result property="payee.name" column="payee_name"/>
        <result property="rhParticipating" column="is_rh_participating_flag"/>
        <result property="payeeParticipating" column="is_payee_participating_flag"/>
        <result property="comment" column="comment"/>
        <result property="aaclUsage.institution" column="institution"/>
        <result property="aaclUsage.usagePeriod" column="usage_period"/>
        <result property="aaclUsage.usageSource" column="usage_source"/>
        <result property="aaclUsage.numberOfPages" column="number_of_pages"/>
        <result property="aaclUsage.rightLimitation" column="right_limitation"/>
        <result property="aaclUsage.batchPeriodEndDate" column="batch_period_end_date"/>
    </resultMap>

    <resultMap id="wrWrkInstToUsageIdResultMap" type="WrWrkInstUsageIdPair">
        <result property="wrWrkInst" column="wr_wrk_inst"/>
        <result property="usageId" column="df_usage_uid"/>
    </resultMap>

    <resultMap id="payeeTotalHolderResultMap" type="PayeeTotalHolder">
        <result property="payee.name" column="payee_name"/>
        <result property="payee.accountNumber" column="payee_account_number"/>
        <result property="grossTotal" column="gross_total"/>
        <result property="serviceFeeTotal" column="service_fee_total"/>
        <result property="netTotal" column="net_total"/>
        <result property="payeeParticipating" column="is_payee_participating_flag"/>
    </resultMap>

    <sql id="usageColumns">
        df_usage_batch_uid,
        df_scenario_uid,
        wr_wrk_inst,
        work_title,
        system_title,
        rh_account_number,
        status_ind,
        product_family,
        standard_number,
        standard_number_type,
        number_of_copies,
        gross_amount,
        comment
    </sql>

    <sql id="usageDtoColumns">
        u.df_scenario_uid,
        u.wr_wrk_inst,
        u.work_title,
        u.system_title,
        u.rh_account_number,
        rh.name rh_name,
        u.payee_account_number,
        p.name payee_name,
        u.status_ind,
        u.product_family,
        u.standard_number,
        u.standard_number_type,
        u.number_of_copies,
        u.gross_amount,
        u.service_fee_amount,
        u.net_amount,
        u.service_fee,
        ub.gross_amount batch_gross_amount,
        ub.name batch_name,
        ub.rro_account_number,
        rro.name rro_name,
        ub.payment_date,
        ub.fiscal_year,
        u.updated_datetime,
        u.comment,
        ufas.article,
        ufas.author,
        ufas.publisher,
        ufas.publication_date,
        ufas.market,
        ufas.market_period_from,
        ufas.market_period_to,
        ufas.reported_value
    </sql>

    <sql id="selectUsageDtos">
        select
            u.df_usage_uid,
            <include refid="IUsageMapper.usageDtoColumns"/>
        from ${schema}.df_usage u
        join ${schema}.df_usage_fas ufas on u.df_usage_uid = ufas.df_usage_fas_uid
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        left join ${schema}.df_rightsholder rro on rro.rh_account_number = ub.rro_account_number
        left join ${schema}.df_rightsholder p on p.rh_account_number = u.payee_account_number
    </sql>

    <sql id="scenarioBatchesFilter">
        df_usage_batch_uid in (
            select filter_to_batch_map.df_usage_batch_uid
            from ${schema}.df_scenario_usage_filter usage_filter
            left join ${schema}.df_scenario_usage_filter_to_usage_batches_ids_map filter_to_batch_map
                on usage_filter.df_scenario_usage_filter_uid = filter_to_batch_map.df_scenario_usage_filter_uid
            where usage_filter.df_scenario_uid = #{scenarioId}
        )
    </sql>

    <sql id="usageFilter">
        <where>
            <if test="filter.usageBatchesIds.size() > 0">
                and
                <foreach collection="filter.usageBatchesIds" item="usageBatchId" open="(" separator=" or " close=")">
                    u.df_usage_batch_uid = #{usageBatchId}
                </foreach>
            </if>
            <if test="filter.rhAccountNumbers.size() > 0">
                and
                <foreach collection="filter.rhAccountNumbers" item="rhAccountNumber" open="(" separator=" or " close=")">
                    ub.rro_account_number = #{rhAccountNumber}
                </foreach>
            </if>
            <if test="null != filter.productFamily">
                and u.product_family = #{filter.productFamily}
            </if>
            <if test="null != filter.paymentDate">
                and <![CDATA[ub.payment_date <= #{filter.paymentDate}]]>
            </if>
            <if test="null != filter.usageStatus">
                and u.status_ind = #{filter.usageStatus}
            </if>
            <if test="null != filter.fiscalYear">
                and <![CDATA[ub.fiscal_year <= #{filter.fiscalYear}]]>
            </if>
            <if test="null != filter.usagePeriod">
                and uaacl.usage_period = #{filter.usagePeriod}
            </if>
        </where>
    </sql>

    <sql id="ifPageable">
        <if test="null != pageable">
            limit #{pageable.limit}
            offset #{pageable.offset}
        </if>
    </sql>

    <sql id="direction">
        <choose>
            <when test="sort.direction == 'asc'">
                asc
            </when>
            <otherwise>
                desc
            </otherwise>
        </choose>
    </sql>

    <sql id="chooseSortProperty">
        <choose>
            <when test="sort.property == 'productFamily'">
                u.product_family <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'detailId'">
                ${detail_uid} <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'batchName'">
                ub.name <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'fiscalYear'">
                ub.fiscal_year <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'rroAccountNumber'">
                ub.rro_account_number <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'rroName'">
                rro.name <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'paymentDate'">
                ub.payment_date <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'workTitle'">
                u.work_title <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'article'">
                ufas.article <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'standardNumber'">
                u.standard_number <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'standardNumberType'">
                u.standard_number_type <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'wrWrkInst'">
                u.wr_wrk_inst <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'systemTitle'">
                u.system_title <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'rhAccountNumber'">
                u.rh_account_number <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'rhName'">
                rh.name <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'publisher'">
                ufas.publisher <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'publicationDate'">
                ufas.publication_date <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'numberOfCopies'">
                u.number_of_copies <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'reportedValue'">
                ufas.reported_value <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'grossAmount'">
                u.gross_amount <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'batchGrossAmount'">
                ub.gross_amount <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'serviceFeeAmount'">
                u.service_fee_amount <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'netAmount'">
                u.net_amount <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'serviceFee'">
                u.service_fee <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'market'">
                ufas.market <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'marketPeriodFrom'">
                ufas.market_period_from <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'marketPeriodTo'">
                ufas.market_period_to <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'author'">
                ufas.author <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'status'">
                u.status_ind <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'comment'">
                u.comment <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'institution'">
                uaacl.institution <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'usagePeriod'">
                uaacl.usage_period <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'usageSource'">
                uaacl.usage_source <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'numberOfPages'">
                uaacl.number_of_pages <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'rightLimitation'">
                uaacl.right_limitation <include refid="IUsageMapper.direction"/>
            </when>
        </choose>
    </sql>

    <sql id="rightsholderTotalHoldersOrderBy">
        order by
        <choose>
            <when test="null != sort">
                <choose>
                    <when test="sort.property == 'rightsholder.name'">
                        r.name <include refid="IUsageMapper.direction"/>
                    </when>
                    <when test="sort.property == 'rightsholder.accountNumber'">
                        u.rh_account_number <include refid="IUsageMapper.direction"/>
                    </when>
                    <when test="sort.property == 'payee.name'">
                        p.name <include refid="IUsageMapper.direction"/>
                    </when>
                    <when test="sort.property == 'payee.accountNumber'">
                        p.rh_account_number <include refid="IUsageMapper.direction"/>
                    </when>
                    <when test="sort.property == 'grossTotal'">
                        u.gross_total <include refid="IUsageMapper.direction"/>
                    </when>
                    <when test="sort.property == 'serviceFeeTotal'">
                        u.service_fee_total <include refid="IUsageMapper.direction"/>
                    </when>
                    <when test="sort.property == 'serviceFee'">
                        u.service_fee <include refid="IUsageMapper.direction"/>
                    </when>
                    <when test="sort.property == 'netTotal'">
                        u.net_total <include refid="IUsageMapper.direction"/>
                    </when>
                </choose>
            </when>
            <otherwise>
                r.name asc
            </otherwise>
        </choose>
    </sql>

    <sql id="searchWhereClause">
        (r.name ilike '%' || #{searchValue} || '%' or
        cast(u.rh_account_number as text) like '%' || #{searchValue} || '%')
    </sql>

    <sql id="drillDownSearchWhereClause">
        ${detail_uid} like '%' || #{searchValue} || '%' or
        u.standard_number ilike '%' || #{searchValue} || '%' or
        cast(u.wr_wrk_inst as text) like '%' || #{searchValue} || '%' or
        rro.name ilike '%' || #{searchValue} || '%' or
        cast(ub.rro_account_number as text) like '%' || #{searchValue} || '%'
    </sql>

    <insert id="insert" parameterType="Usage">
        with u as (
            insert into ${schema}.df_usage (
                df_usage_uid,
                <include refid="usageColumns"/>,
                payee_account_number,
                <include refid="StoredEntityMapper.additionalColumns"/>
            )
            values (
                #{id},
                #{batchId},
                #{scenarioId},
                #{wrWrkInst},
                #{workTitle},
                #{systemTitle},
                #{rightsholder.accountNumber},
                #{status},
                #{productFamily},
                #{standardNumber},
                #{standardNumberType},
                #{numberOfCopies},
                #{grossAmount},
                #{comment},
                #{payee.accountNumber},
                <include refid="StoredEntityMapper.insert"/>
            )
        )
        insert into ${schema}.df_usage_fas (
            df_usage_fas_uid,
            article,
            publisher,
            publication_date,
            market,
            market_period_from,
            market_period_to,
            author,
            reported_value,
            <include refid="StoredEntityMapper.additionalColumns"/>
        )
        select
            #{id},
            #{article},
            #{publisher},
            #{publicationDate},
            #{market},
            #{marketPeriodFrom},
            #{marketPeriodTo},
            #{author},
            #{reportedValue},
            <include refid="StoredEntityMapper.insert"/>
    </insert>

    <insert id="insertAaclUsage" parameterType="Usage">
        with u as (
            insert into ${schema}.df_usage (
                df_usage_uid,
                <include refid="usageColumns"/>,
                payee_account_number,
                <include refid="StoredEntityMapper.additionalColumns"/>
            )
            values (
                #{id},
                #{batchId},
                #{scenarioId},
                #{wrWrkInst},
                #{workTitle},
                #{systemTitle},
                #{rightsholder.accountNumber},
                #{status},
                #{productFamily},
                #{standardNumber},
                #{standardNumberType},
                #{numberOfCopies},
                #{grossAmount},
                #{comment},
                #{payee.accountNumber},
                <include refid="StoredEntityMapper.insert"/>
             )
        )
        insert into ${schema}.df_usage_aacl (
            df_usage_aacl_uid,
            institution,
            usage_period,
            usage_source,
            number_of_pages,
            right_limitation,
            <include refid="StoredEntityMapper.additionalColumns"/>
        )
        select
            #{id},
            #{aaclUsage.institution},
            #{aaclUsage.usagePeriod},
            #{aaclUsage.usageSource},
            #{aaclUsage.numberOfPages},
            #{aaclUsage.rightLimitation},
            <include refid="StoredEntityMapper.insert"/>
    </insert>

    <sql id="selectDtosByFilterSql">
        <include refid="IUsageMapper.selectUsageDtos"/>
        <include refid="IUsageMapper.usageFilter"/>
        and u.df_scenario_uid is null
        order by
        <choose>
            <when test="null != sort">
                <include refid="IUsageMapper.chooseSortProperty">
                    <property name="detail_uid" value="u.df_usage_uid"/>
                </include>
            </when>
            <otherwise>
                updated_datetime desc, df_usage_uid
            </otherwise>
        </choose>
        <include refid="IUsageMapper.ifPageable"/>
    </sql>

    <select id="findDtosByFilter" resultMap="usageDtoResultMap" parameterType="map" fetchSize="${usageSelectFetchSize}">
        select
            u.df_usage_uid,
            u.df_scenario_uid,
            u.wr_wrk_inst,
            u.work_title,
            u.system_title,
            u.rh_account_number,
            rh.name rh_name,
            u.payee_account_number,
            p.name payee_name,
            u.status_ind,
            u.product_family,
            u.standard_number,
            u.standard_number_type,
            u.number_of_copies,
            u.gross_amount,
            u.service_fee_amount,
            u.net_amount,
            u.service_fee,
            ub.gross_amount batch_gross_amount,
            ub.name batch_name,
            ub.rro_account_number,
            rro.name rro_name,
            ub.payment_date,
            ub.fiscal_year,
            u.updated_datetime,
            u.comment,
            <choose>
                <when test="filter.productFamily == 'AACL'">
                    ub.payment_date as batch_period_end_date,
                    uaacl.institution,
                    uaacl.usage_period,
                    uaacl.usage_source,
                    uaacl.number_of_pages,
                    uaacl.right_limitation
                </when>
                <otherwise>
                    ufas.article,
                    ufas.author,
                    ufas.publisher,
                    ufas.publication_date,
                    ufas.market,
                    ufas.market_period_from,
                    ufas.market_period_to,
                    ufas.reported_value
                </otherwise>
            </choose>
        from ${schema}.df_usage u
        <choose>
            <when test="filter.productFamily == 'AACL'">
                join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
            </when>
            <otherwise>
                join ${schema}.df_usage_fas ufas on u.df_usage_uid = ufas.df_usage_fas_uid
            </otherwise>
        </choose>
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        left join ${schema}.df_rightsholder rro on rro.rh_account_number = ub.rro_account_number
        left join ${schema}.df_rightsholder p on p.rh_account_number = u.payee_account_number
        <include refid="IUsageMapper.usageFilter"/>
        and u.df_scenario_uid is null
        order by
        <choose>
            <when test="null != sort">
                <include refid="IUsageMapper.chooseSortProperty">
                    <property name="detail_uid" value="u.df_usage_uid"/>
                </include>
            </when>
            <otherwise>
                updated_datetime desc, df_usage_uid
            </otherwise>
        </choose>
        <include refid="IUsageMapper.ifPageable"/>
    </select>

    <select id="findIdsByStatusAndProductFamily" resultType="string" parameterType="map">
        select df_usage_uid
        from ${schema}.df_usage
        where status_ind = #{status}
            and product_family = #{productFamily}
        order by df_usage_uid
    </select>

    <select id="findByStatusAndProductFamily" resultMap="usageResultMap" parameterType="map">
        select
            u.df_usage_uid,
            u.df_usage_batch_uid,
            u.df_scenario_uid,
            ufas.df_fund_pool_uid,
            u.wr_wrk_inst,
            u.work_title,
            u.system_title,
            u.rh_account_number,
            rh.df_rightsholder_uid as rh_id,
            rh.name as rh_name,
            u.status_ind,
            u.product_family,
            ufas.article,
            u.standard_number,
            u.standard_number_type,
            ufas.publisher,
            ufas.publication_date,
            ufas.market,
            ufas.market_period_from,
            ufas.market_period_to,
            ufas.author,
            u.number_of_copies,
            ufas.reported_value,
            u.gross_amount,
            u.record_version
        from ${schema}.df_usage u
        join ${schema}.df_usage_fas ufas on u.df_usage_uid = ufas.df_usage_fas_uid
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        where
            u.status_ind = #{status} and
            u.product_family = #{productFamily}
        order by u.df_usage_uid
    </select>

    <select id="findByScenarioId" resultMap="usageResultMap" parameterType="string">
        select
            u.df_usage_uid,
            u.df_usage_batch_uid,
            u.df_scenario_uid,
            u.wr_wrk_inst,
            u.work_title,
            u.system_title,
            u.rh_account_number,
            rh.df_rightsholder_uid rh_id,
            rh.name rh_name,
            u.status_ind,
            u.product_family,
            u.standard_number,
            u.standard_number_type,
            u.number_of_copies,
            u.gross_amount,
            u.service_fee,
            u.service_fee_amount,
            u.net_amount,
            u.payee_account_number,
            p.df_rightsholder_uid payee_id,
            p.name payee_name,
            ufas.article,
            ufas.publisher,
            ufas.publication_date,
            ufas.market,
            ufas.market_period_from,
            ufas.market_period_to,
            ufas.author,
            ufas.reported_value,
            ufas.is_rh_participating_flag,
            ufas.df_fund_pool_uid,
            u.comment
        from ${schema}.df_usage u
        join ${schema}.df_usage_fas ufas on u.df_usage_uid = ufas.df_usage_fas_uid
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        left join ${schema}.df_rightsholder p on p.rh_account_number = u.payee_account_number
        where df_scenario_uid = #{scenarioId}
    </select>

    <select id="findForReconcile" resultMap="usageResultMap" parameterType="string">
        select
            u.df_usage_uid,
            u.wr_wrk_inst,
            u.work_title,
            u.system_title,
            u.rh_account_number,
            rh.df_rightsholder_uid rh_id,
            rh.name rh_name,
            u.payee_account_number,
            p.df_rightsholder_uid payee_id,
            p.name payee_name,
            u.product_family,
            u.status_ind,
            u.gross_amount
        from ${schema}.df_usage u
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        left join ${schema}.df_rightsholder p on p.rh_account_number = u.payee_account_number
        where df_scenario_uid = #{scenarioId}
        order by df_usage_uid
    </select>

    <select id="findRightsholdersInformation" resultMap="usageResultMap" parameterType="string">
        select distinct
            u.rh_account_number,
            rh.df_rightsholder_uid rh_id,
            p.df_rightsholder_uid payee_id,
            u.payee_account_number,
            ufas.is_rh_participating_flag,
            ufas.is_payee_participating_flag
        from ${schema}.df_usage u
        join ${schema}.df_usage_fas ufas on u.df_usage_uid = ufas.df_usage_fas_uid
        join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        left join ${schema}.df_rightsholder p on p.rh_account_number = u.payee_account_number
        where df_scenario_uid = #{scenarioId}
    </select>

    <sql id="selectDtoByScenarioIdSql">
        <include refid="IUsageMapper.selectUsageDtos"/>
        where df_scenario_uid = #{scenarioId}
        order by u.rh_account_number
        <include refid="IUsageMapper.ifPageable"/>
    </sql>

    <sql id="selectCountByFilterSql">
        select count(1)
        from ${schema}.df_usage u
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        left join ${schema}.df_rightsholder rro on rro.rh_account_number = ub.rro_account_number
        <include refid="IUsageMapper.usageFilter"/>
            and u.df_scenario_uid is null
    </sql>

    <select id="findCountByFilter" parameterType="map" resultType="int">
        select count(1)
        from ${schema}.df_usage u
        <choose>
            <when test="filter.productFamily == 'AACL'">
                join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
            </when>
            <otherwise>
                join ${schema}.df_usage_fas ufas on u.df_usage_uid = ufas.df_usage_fas_uid
            </otherwise>
        </choose>
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        left join ${schema}.df_rightsholder rro on rro.rh_account_number = ub.rro_account_number
        <include refid="IUsageMapper.usageFilter"/>
        and u.df_scenario_uid is null
    </select>

    <select id="findByIds" resultMap="usageResultMap">
        select
            u.df_usage_uid,
            u.df_usage_batch_uid,
            u.df_scenario_uid,
            ufas.df_fund_pool_uid,
            u.wr_wrk_inst,
            u.work_title,
            u.system_title,
            u.rh_account_number,
            r.name rh_name,
            r.df_rightsholder_uid rh_id,
            u.payee_account_number,
            p.name payee_name,
            p.df_rightsholder_uid payee_id,
            u.status_ind,
            u.product_family,
            ufas.article,
            u.standard_number,
            u.standard_number_type,
            ufas.publisher,
            ufas.publication_date,
            ufas.market,
            ufas.market_period_from,
            ufas.market_period_to,
            ufas.author,
            u.comment,
            u.number_of_copies,
            ufas.reported_value,
            u.gross_amount,
            u.service_fee_amount,
            u.service_fee,
            u.net_amount,
            ufas.is_rh_participating_flag,
            ufas.is_payee_participating_flag,
            ub.payment_date batch_period_end_date,
            uaacl.right_limitation,
            u.created_datetime,
            u.updated_datetime,
            u.created_by_user,
            u.updated_by_user,
            u.record_version
        from ${schema}.df_usage u
        <!--TODO {isuvorau/srudak} find solution to not join both tables at a time -->
        left join ${schema}.df_usage_fas ufas on u.df_usage_uid = ufas.df_usage_fas_uid
        left join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_rightsholder r on r.rh_account_number = u.rh_account_number
        left join ${schema}.df_rightsholder p on p.rh_account_number = u.payee_account_number
        where u.df_usage_uid in
        <foreach collection="list" item="usageId" open="(" separator="," close=")">
            #{usageId}
        </foreach>
        order by u.df_usage_uid
    </select>

    <select id="findUsageIdsForClassificationUpdate" parameterType="map" resultType="string">
        select u.df_usage_uid
        from ${schema}.df_usage u
        join ${schema}.df_work_classification wc on u.wr_wrk_inst = wc.wr_wrk_inst
        where u.status_ind = #{unclassifiedStatus}
            or (wc.classification = #{belletristicClassification}
                and product_family = #{productFamily}
                and status_ind = #{eligibleStatus}
            )
    </select>

    <select id="findCountByStatusAndWrWrkInsts" resultType="int">
        select count(1)
        from ${schema}.df_usage
        where status_ind = #{status}
            and wr_wrk_inst in
            <foreach collection="wrWrkInsts" item="wrWrkInst" open="(" separator="," close=")">
                #{wrWrkInst}
            </foreach>
    </select>

    <delete id="deleteByBatchId" parameterType="string">
        with u as (
            delete from ${schema}.df_usage
            where df_usage_batch_uid = #{batchId}
            returning df_usage_uid
        )
        delete from ${schema}.df_usage_fas
        where df_usage_fas_uid in (select df_usage_uid from u)
    </delete>

    <delete id="deleteByUsageId" parameterType="string">
        with u as (
            delete from ${schema}.df_usage
            where df_usage_uid = #{usageId}
        ),
        fas as (
            delete from ${schema}.df_usage_fas
            where df_usage_fas_uid = #{usageId}
        )
        delete from ${schema}.df_usage_aacl
        where df_usage_aacl_uid = #{usageId}
    </delete>

    <delete id="deleteByScenarioId" parameterType="string">
        delete from ${schema}.df_usage
        where df_scenario_uid = #{scenarioId}
    </delete>

    <delete id="deleteNtsByScenarioId" parameterType="map">
        with u as (
            delete from ${schema}.df_usage
            where df_scenario_uid = #{scenarioId}
                or (<include refid="scenarioBatchesFilter"/> and status_ind = #{status})
            returning df_usage_uid
        )
        delete from ${schema}.df_usage_fas
        where df_usage_fas_uid in (select df_usage_uid from u)
    </delete>

    <delete id="deleteBelletristicByScenarioId" parameterType="map">
        with u as (
            delete from ${schema}.df_usage
            where df_usage_uid in (
                select u.df_usage_uid
                from ${schema}.df_usage u
                join ${schema}.df_work_classification wc on wc.wr_wrk_inst = u.wr_wrk_inst
                    and wc.classification = #{belletristicClassification}
                where <include refid="scenarioBatchesFilter"/>)
            returning df_usage_uid
        )
        delete from ${schema}.df_usage_fas
        where df_usage_fas_uid in (select df_usage_uid from u)
    </delete>

    <update id="deleteFromPreServiceFeeFund" parameterType="map">
        with ufas as (
            update
                ${schema}.df_usage_fas
            set
                df_fund_pool_uid = null,
                <include refid="StoredEntityMapper.update"/>
            where df_fund_pool_uid = #{fundPoolId}
            returning df_usage_fas_uid
        )
        update ${schema}.df_usage
        set
            status_ind = #{status},
            <include refid="StoredEntityMapper.update"/>
        from ufas
        where df_usage_uid = ufas.df_usage_fas_uid
    </update>

    <select id="findWithAmountsAndRightsholders" parameterType="map" resultMap="usageAmountResultMap">
        select
            u.df_usage_uid,
            u.gross_amount,
            u.net_amount,
            u.service_fee,
            u.service_fee_amount,
            ufas.reported_value,
            u.service_fee,
            u.created_datetime,
            u.updated_datetime,
            u.created_by_user,
            u.updated_by_user,
            u.record_version,
            u.status_ind,
            u.product_family,
            r.df_rightsholder_uid rh_id,
            u.rh_account_number,
            r.name rh_name
        from ${schema}.df_usage u
        join ${schema}.df_usage_fas ufas on u.df_usage_uid = ufas.df_usage_fas_uid
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_rightsholder r on u.rh_account_number = r.rh_account_number
        <include refid="usageFilter"/>
        and u.status_ind = #{status}
    </select>

    <select id="findInvalidRightsholdersByFilter" parameterType="map" resultType="long">
        select distinct
            u.rh_account_number
        from ${schema}.df_usage u
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_rightsholder r on u.rh_account_number = r.rh_account_number
        <include refid="usageFilter"/>
            and r.df_rightsholder_uid is null
    </select>

    <update id="addToScenario" parameterType="Usage" >
        with u as (
            update ${schema}.df_usage
            set
                status_ind = #{status},
                df_scenario_uid = #{scenarioId},
                payee_account_number = #{payee.accountNumber},
                net_amount = #{netAmount},
                service_fee_amount = #{serviceFeeAmount},
                service_fee = #{serviceFee},
                <include refid="StoredEntityMapper.update"/>
            where df_usage_uid = #{id}
        )
        update ${schema}.df_usage_fas
        set
            is_rh_participating_flag = #{rhParticipating},
            is_payee_participating_flag = #{payeeParticipating},
            <include refid="StoredEntityMapper.update"/>
        where df_usage_fas_uid = #{id}
    </update>

    <select id="deleteFromScenarioByPayees" parameterType="map" resultType="string">
        with u as (
            update ${schema}.df_usage
            set
                status_ind = #{status},
                df_scenario_uid = null,
                payee_account_number = null,
                service_fee = null,
                service_fee_amount = 0,
                net_amount = 0,
                <include refid="StoredEntityMapper.update"/>
                where df_scenario_uid = #{scenarioId}
                    and payee_account_number in
                    <foreach collection="accountNumbers" item="accountNumber" separator="," open="(" close=")">
                        #{accountNumber}
                    </foreach>
                returning df_usage_uid
        )
        update ${schema}.df_usage_fas
        set
            is_rh_participating_flag = false,
            is_payee_participating_flag = false,
            <include refid="StoredEntityMapper.update"/>
        from u
        where df_usage_fas_uid = u.df_usage_uid
        returning u.df_usage_uid
    </select>

    <select id="redesignateToNtsWithdrawnByPayees" parameterType="map" resultType="string">
        with u as (
            update ${schema}.df_usage
            set
                status_ind = #{status},
                product_family = #{productFamily},
                df_scenario_uid = null,
                payee_account_number = null,
                service_fee = null,
                service_fee_amount = 0,
                net_amount = 0,
                <include refid="StoredEntityMapper.update"/>
            where df_scenario_uid = #{scenarioId}
                and payee_account_number in
                <foreach collection="accountNumbers" item="accountNumber" separator="," open="(" close=")">
                    #{accountNumber}
                </foreach>
            returning df_usage_uid
        )
        update ${schema}.df_usage_fas
        set
            is_rh_participating_flag = false,
            is_payee_participating_flag = false,
            <include refid="StoredEntityMapper.update"/>
        from u
        where df_usage_fas_uid = u.df_usage_uid
        returning u.df_usage_uid
    </select>

    <sql id="deleteFromScenarioSql">
        update ${schema}.df_usage
        set
            status_ind = #{status},
            df_scenario_uid = null,
            payee_account_number = null,
            service_fee = null,
            service_fee_amount = 0,
            net_amount = 0,
            <include refid="StoredEntityMapper.update"/>
    </sql>

    <update id="deleteFromScenario" parameterType="map">
        with usage_ids as (
            <include refid="deleteFromScenarioSql"/>
            where df_scenario_uid = #{scenarioId}
            returning df_usage_uid
        )
        update ${schema}.df_usage_fas
        set
            is_rh_participating_flag = false,
            is_payee_participating_flag = false,
            <include refid="StoredEntityMapper.update"/>
        from usage_ids
        where df_usage_fas_uid = usage_ids.df_usage_uid
    </update>

    <update id="deleteFromScenarioByUsageId" parameterType="map">
        with result as (
            <include refid="deleteFromScenarioSql"/>
            where df_usage_uid = #{usageId}
        )
        update ${schema}.df_usage_fas
        set
            is_rh_participating_flag = false,
            is_payee_participating_flag = false,
            <include refid="StoredEntityMapper.update"/>
        where df_usage_fas_uid = #{usageId}
    </update>

    <update id="deleteFromNtsScenario" parameterType="map">
        with usage_ids as (
            update
                ${schema}.df_usage u
            set
                status_ind = case when usage_with_classification.classification is not null then #{eligibleStatus} else #{unclassifiedStatus} end,
                df_scenario_uid = null,
                service_fee = null,
                service_fee_amount = 0,
                net_amount = 0,
                gross_amount = 0,
                <include refid="StoredEntityMapper.update"/>
            from (
                select
                    u.df_usage_uid,
                    wc.classification
                from ${schema}.df_usage u
                left join ${schema}.df_work_classification wc on wc.wr_wrk_inst = u.wr_wrk_inst
                where <include refid="scenarioBatchesFilter"/>
                    and status_ind in
                    <foreach collection="statusesToUpdate" item="statusToUpdate" separator="," open="(" close=")">
                        #{statusToUpdate}
                    </foreach>) as usage_with_classification
            where u.df_usage_uid = usage_with_classification.df_usage_uid
            returning u.df_usage_uid
        )
        update ${schema}.df_usage_fas
        set
            is_rh_participating_flag = false,
            <include refid="StoredEntityMapper.update"/>
        from usage_ids
        where df_usage_fas_uid = usage_ids.df_usage_uid
    </update>

    <select id="findCountByUsageIdAndStatus" parameterType="map" resultType="int">
        select count(1)
            from (
                select df_usage_uid
                from ${schema}.df_usage
                where df_usage_uid = #{usageId}
                    and status_ind = #{status}
            union
                select df_usage_archive_uid
                from ${schema}.df_usage_archive
                where df_usage_archive_uid = #{usageId}
                    and status_ind = #{status}
            ) as usage_uid;
    </select>

    <sql id="selectRightsholderTotalsHoldersByScenarioIdSql">
        select
            r.name rh_name,
            u.rh_account_number,
            p.name payee_name,
            u.payee_account_number,
            u.gross_total,
            u.service_fee_total,
            u.net_total,
            u.service_fee
        from (
            select
                rh_account_number,
                payee_account_number,
                sum(gross_amount) gross_total,
                sum(service_fee_amount) service_fee_total,
                sum(net_amount) net_total,
                service_fee
            from ${schema}.df_usage
            where df_scenario_uid = #{scenarioId}
            group by rh_account_number, payee_account_number, service_fee
        ) u
        left join ${schema}.df_rightsholder r on u.rh_account_number = r.rh_account_number
        left join ${schema}.df_rightsholder p on u.payee_account_number = p.rh_account_number
        <if test="null != searchValue">
            where <include refid="IUsageMapper.searchWhereClause"/>
        </if>
        <include refid="IUsageMapper.rightsholderTotalHoldersOrderBy"/>
        <include refid="IUsageMapper.ifPageable"/>
    </sql>

    <select id="findRightsholderTotalsHoldersByScenarioId" parameterType="map" resultMap="rightsholderTotalsHolderResultMap">
        <include refid="IUsageMapper.selectRightsholderTotalsHoldersByScenarioIdSql"/>
    </select>

    <select id="findPayeeTotalHoldersByScenarioId" parameterType="string" resultMap="payeeTotalHolderResultMap">
        select
            p.name payee_name,
            u.payee_account_number,
            u.gross_total,
            u.service_fee_total,
            u.net_total,
            u.is_payee_participating_flag
        from (
            select
                u.payee_account_number,
                sum(u.gross_amount) gross_total,
                sum(u.service_fee_amount) service_fee_total,
                sum(u.net_amount) net_total,
                ufas.is_payee_participating_flag
            from ${schema}.df_usage u
            join ${schema}.df_usage_fas ufas on u.df_usage_uid = ufas.df_usage_fas_uid
            where df_scenario_uid = #{scenarioId}
            group by payee_account_number, ufas.is_payee_participating_flag
        ) u
        left join ${schema}.df_rightsholder p on u.payee_account_number = p.rh_account_number
        order by p.name asc
    </select>

    <select id="getTotalAmountByStandardNumberAndBatchId" parameterType="map" resultType="BigDecimal">
        select sum(gross_amount)
        from ${schema}.df_usage
        where standard_number = #{standardNumber}
            and df_usage_batch_uid = #{batchId}
            and status_ind in
            <foreach collection="statuses" item="status" separator="," open="(" close=")">
                #{status}
            </foreach>
    </select>

    <select id="getTotalAmountByTitleAndBatchId" parameterType="map" resultType="BigDecimal">
        select sum(gross_amount)
        from ${schema}.df_usage
        where work_title = #{title}
            and standard_number is null
            and df_usage_batch_uid = #{batchId}
            and status_ind in
            <foreach collection="statuses" item="status" separator="," open="(" close=")">
                #{status}
            </foreach>
    </select>

    <select id="updateNtsWithdrawnUsagesAndGetIds" parameterType="map" resultType="string">
        with works as (
            select
                df_usage_batch_uid,
                wr_wrk_inst,
                sum(gross_amount)
            from ${schema}.df_usage
            where status_ind  = #{statusToFind}
            group by wr_wrk_inst, df_usage_batch_uid
            having sum(gross_amount) &lt; #{minimumTotal}
        )

        update ${schema}.df_usage
        set
            status_ind = #{statusToSet},
            product_family = #{productFamily}
        where df_usage_batch_uid in (select df_usage_batch_uid from works)
            and wr_wrk_inst in (select wr_wrk_inst from works)
        returning df_usage_uid
    </select>

    <select id="findRightsholderTotalsHolderCountByScenarioId" parameterType="map" resultType="int">
        select count(1)
        from (
            select distinct rh_account_number
            from ${schema}.df_usage
            where df_scenario_uid = #{scenarioId}) u
        left join ${schema}.df_rightsholder r on u.rh_account_number = r.rh_account_number
        <if test="null != searchValue">
            where <include refid="searchWhereClause"/>
        </if>
    </select>

    <select id="isScenarioEmpty" parameterType="string" resultType="boolean">
        select not exists (
            select
            from ${schema}.df_usage
            where df_scenario_uid = #{scenarioId}
        )
    </select>

    <select id="findCountByScenarioIdAndRhAccountNumber" parameterType="map" resultType="int">
        select count(1)
        from ${schema}.df_usage u
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_rightsholder rro on ub.rro_account_number = rro.rh_account_number
        where df_scenario_uid = #{scenarioId} and u.rh_account_number = #{accountNumber}
        <if test="null != searchValue">
            and (
                <include refid="drillDownSearchWhereClause">
                    <property name="detail_uid" value="u.df_usage_uid"/>
                </include>
            )
        </if>
    </select>

    <select id="findByScenarioIdAndRhAccountNumber" parameterType="map" resultMap="usageDtoResultMap">
        <include refid="selectUsageDtos"/>
        where u.df_scenario_uid = #{scenarioId} and u.rh_account_number = #{accountNumber}
        <if test="null != searchValue">
            and (
                <include refid="drillDownSearchWhereClause">
                    <property name="detail_uid" value="u.df_usage_uid"/>
                </include>
            )
        </if>
        order by
        <choose>
            <when test="null != sort">
                <include refid="chooseSortProperty">
                    <property name="detail_uid" value="u.df_usage_uid"/>
                </include>
            </when>
            <otherwise>
                df_usage_uid
            </otherwise>
        </choose>
        <include refid="ifPageable"/>
    </select>

    <select id="findIdsByScenarioIdRroAccountNumberRhAccountNumbers" resultType="string" parameterType="map">
        select df_usage_uid
        from ${schema}.df_usage u
        join ${schema}.df_usage_batch b on u.df_usage_batch_uid = b.df_usage_batch_uid
        where u.df_scenario_uid = #{scenarioId}
            and b.rro_account_number = #{rroAccountNumber}
            and u.rh_account_number in
            <foreach collection="accountNumbers" item="accountNumber" separator="," open="(" close=")">
                #{accountNumber}
            </foreach>
    </select>

    <sql id="selectArchivedCountForAuditSql">
        (select count(1) usage_count
        from ${schema}.df_usage_archive u
        left join ${schema}.df_usage_batch ub on ub.df_usage_batch_uid = u.df_usage_batch_uid
        left join ${schema}.df_scenario s on s.df_scenario_uid = u.df_scenario_uid
        <include refid="IUsageMapper.archivedAuditFilterWhereClause"/>)
    </sql>

    <sql id="selectCountForAuditSql">
        select
        <choose>
            <when test="null != filter.cccEventId || null != filter.distributionName">
                <include refid="IUsageMapper.selectArchivedCountForAuditSql"/>
            </when>
            <otherwise>
                (select count(1) usage_count
                from ${schema}.df_usage u
                join ${schema}.df_usage_batch ub on ub.df_usage_batch_uid = u.df_usage_batch_uid
                left join ${schema}.df_scenario s on s.df_scenario_uid = u.df_scenario_uid
                <where>
                    <include refid="IUsageMapper.commonAuditFilterWhereClause">
                        <property name="detail_uid" value="u.df_usage_uid"/>
                    </include>
                </where>) +
                <include refid="IUsageMapper.selectArchivedCountForAuditSql"/>
            </otherwise>
        </choose>
    </sql>

    <select id="findCountForAudit" resultType="int" parameterType="map">
        <include refid="IUsageMapper.selectCountForAuditSql"/>
    </select>

    <sql id="selectForAuditSql">
        <choose>
            <when test="null != filter.cccEventId || null != filter.distributionName">
                <include refid="IUsageMapper.selectArchivedUsagesForAuditSql"/>
            </when>
            <otherwise>
                select
                    u.df_usage_uid,
                    u.status_ind,
                    u.product_family,
                    u.df_usage_batch_uid,
                    ub.name batch_name,
                    ub.payment_date,
                    u.rh_account_number,
                    rh.name rh_name,
                    u.payee_account_number,
                    payee.name payee_name,
                    wr_wrk_inst,
                    work_title,
                    system_title,
                    standard_number,
                    standard_number_type,
                    ufas.reported_value,
                    u.gross_amount,
                    service_fee,
                    ub.gross_amount batch_gross_amount,
                    u.updated_datetime,
                    s.name scenario_name,
                    null check_number,
                    null check_date,
                    null ccc_event_id,
                    null distribution_name,
                    null distribution_date,
                    null period_end_date,
                    u.comment
                from ${schema}.df_usage u
                join ${schema}.df_usage_fas ufas on u.df_usage_uid = ufas.df_usage_fas_uid
                join ${schema}.df_usage_batch ub on ub.df_usage_batch_uid = u.df_usage_batch_uid
                left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
                left join ${schema}.df_rightsholder payee on payee.rh_account_number = u.payee_account_number
                left join ${schema}.df_scenario s on s.df_scenario_uid = u.df_scenario_uid
                <where>
                    <include refid="IUsageMapper.commonAuditFilterWhereClause">
                        <property name="detail_uid" value="u.df_usage_uid"/>
                    </include>
                </where>
                union
                <include refid="IUsageMapper.selectArchivedUsagesForAuditSql"/>
            </otherwise>
        </choose>
        order by
        <choose>
            <when test="null != sort">
                <choose>
                    <when test="sort.property == 'productFamily'">
                        product_family
                    </when>
                    <when test="sort.property == 'detailId'">
                        df_usage_uid
                    </when>
                    <when test="sort.property == 'status'">
                        status_ind
                    </when>
                    <when test="sort.property == 'batchName'">
                        batch_name
                    </when>
                    <when test="sort.property == 'paymentDate'">
                        payment_date
                    </when>
                    <when test="sort.property == 'rhAccountNumber'">
                        rh_account_number
                    </when>
                    <when test="sort.property == 'rhName'">
                        rh_name
                    </when>
                    <when test="sort.property == 'payeeAccountNumber'">
                        payee_account_number
                    </when>
                    <when test="sort.property == 'payeeName'">
                        payee_name
                    </when>
                    <when test="sort.property == 'wrWrkInst'">
                        wr_wrk_inst
                    </when>
                    <when test="sort.property == 'systemTitle'">
                        system_title
                    </when>
                    <when test="sort.property == 'workTitle'">
                        work_title
                    </when>
                    <when test="sort.property == 'standardNumber'">
                        standard_number
                    </when>
                    <when test="sort.property == 'standardNumberType'">
                        standard_number_type
                    </when>
                    <when test="sort.property == 'reportedValue'">
                        reported_value
                    </when>
                    <when test="sort.property == 'grossAmount'">
                        gross_amount
                    </when>
                    <when test="sort.property == 'batchGrossAmount'">
                        batch_gross_amount
                    </when>
                    <when test="sort.property == 'serviceFee'">
                        service_fee
                    </when>
                    <when test="sort.property == 'scenarioName'">
                        scenario_name
                    </when>
                    <when test="sort.property == 'checkNumber'">
                        check_number
                    </when>
                    <when test="sort.property == 'checkDate'">
                        check_date
                    </when>
                    <when test="sort.property == 'cccEventId'">
                        ccc_event_id
                    </when>
                    <when test="sort.property == 'distributionName'">
                        distribution_name
                    </when>
                    <when test="sort.property == 'distributionDate'">
                        distribution_date
                    </when>
                    <when test="sort.property == 'periodEndDate'">
                        period_end_date
                    </when>
                    <when test="sort.property == 'comment'">
                        comment
                    </when>
                </choose>
                <include refid="IUsageMapper.direction"/>
            </when>
            <otherwise>
                df_usage_uid asc
            </otherwise>
        </choose>
        <include refid="IUsageMapper.ifPageable"/>
    </sql>

    <select id="findForAudit" resultMap="usageDtoResultMap" parameterType="map">
        <include refid="IUsageMapper.selectForAuditSql"/>
    </select>

    <sql id="selectArchivedUsagesForAuditSql">
        select
            df_usage_archive_uid df_usage_uid,
            u.status_ind,
            u.product_family,
            u.df_usage_batch_uid,
            ub.name batch_name,
            ub.payment_date,
            u.rh_account_number,
            rh.name rh_name,
            u.payee_account_number,
            payee.name payee_name,
            wr_wrk_inst,
            work_title,
            system_title,
            standard_number,
            standard_number_type,
            ufas.reported_value,
            u.gross_amount,
            service_fee,
            ub.gross_amount batch_gross_amount,
            u.updated_datetime,
            s.name scenario_name,
            u.check_number,
            u.check_date,
            u.ccc_event_id,
            u.distribution_name,
            u.distribution_date,
            u.period_end_date,
            u.comment
        from ${schema}.df_usage_archive u
        join ${schema}.df_usage_fas ufas on u.df_usage_archive_uid = ufas.df_usage_fas_uid
        left join ${schema}.df_usage_batch ub on ub.df_usage_batch_uid = u.df_usage_batch_uid
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        left join ${schema}.df_rightsholder payee on payee.rh_account_number = u.payee_account_number
        left join ${schema}.df_scenario s on s.df_scenario_uid = u.df_scenario_uid
        <include refid="IUsageMapper.archivedAuditFilterWhereClause"/>
    </sql>

    <sql id="archivedAuditFilterWhereClause">
        <where>
            <include refid="IUsageMapper.commonAuditFilterWhereClause">
                <property name="detail_uid" value="u.df_usage_archive_uid"/>
            </include>
            <if test="null != filter.cccEventId">
                and ccc_event_id ilike '%' || #{filter.cccEventId} || '%'
            </if>
            <if test="null != filter.distributionName">
                and distribution_name ilike '%' || #{filter.distributionName} || '%'
            </if>
        </where>
    </sql>

    <sql id="commonAuditFilterWhereClause">
        <if test="!filter.rhAccountNumbers.isEmpty()">
            u.rh_account_number in
            <foreach collection="filter.rhAccountNumbers" item="accountNumber" separator="," open="(" close=")">
                #{accountNumber}
            </foreach>
        </if>
        <if test="!filter.batchesIds.isEmpty()">
            and ub.df_usage_batch_uid in
            <foreach collection="filter.batchesIds" item="batchId" separator="," open="(" close=")">
                #{batchId}
            </foreach>
        </if>
        <if test="!filter.statuses.isEmpty()">
            and u.status_ind in
            <foreach collection="filter.statuses" item="status" separator="," open="(" close=")">
                #{status}
            </foreach>
        </if>
        <if test="null != filter.productFamily">
            and u.product_family = #{filter.productFamily}
        </if>
        <if test="null != filter.searchValue">
            and (
                ${detail_uid} like '%' || #{filter.searchValue} || '%' or
                cast(wr_wrk_inst as text) like '%' || #{filter.searchValue} || '%' or
                system_title ilike '%' || #{filter.searchValue} || '%' or
                work_title ilike '%' || #{filter.searchValue} || '%')
        </if>
    </sql>

    <select id="findByStatuses" resultMap="usageResultMap">
        select
            u.df_usage_uid,
            u.df_usage_batch_uid,
            u.df_scenario_uid,
            u.wr_wrk_inst,
            u.work_title,
            u.system_title,
            u.rh_account_number,
            u.status_ind,
            u.product_family,
            u.standard_number,
            u.standard_number_type,
            u.number_of_copies,
            u.gross_amount,
            ufas.df_fund_pool_uid,
            ufas.article,
            ufas.publisher,
            ufas.publication_date,
            ufas.market,
            ufas.market_period_from,
            ufas.market_period_to,
            ufas.author,
            ufas.reported_value,
            u.comment
        from ${schema}.df_usage u
        join ${schema}.df_usage_fas ufas on u.df_usage_uid = ufas.df_usage_fas_uid
        where
            u.status_ind in
            <foreach collection="array" item="status" open="(" separator="," close=")">
                #{status}
            </foreach>
    </select>

    <update id="updateStatus" parameterType="map">
        update ${schema}.df_usage
        set status_ind = #{status},
            <include refid="StoredEntityMapper.update"/>
        where df_usage_uid = #{usageId}
    </update>

    <update id="updateStatusAndRhAccountNumber" parameterType="map">
        update ${schema}.df_usage
        set
            status_ind = #{status},
            rh_account_number = #{rhAccountNumber},
            <include refid="StoredEntityMapper.update"/>
        where df_usage_uid in
            <foreach collection="usageIds" item="usageId" open="(" separator="," close=")">
                #{usageId}
            </foreach>
    </update>

    <update id="update" parameterType="Usage">
        with u as (
            update ${schema}.df_usage
            set
                status_ind = #{status},
                wr_wrk_inst = #{wrWrkInst},
                work_title = #{workTitle},
                system_title = #{systemTitle},
                rh_account_number = #{rightsholder.accountNumber},
                payee_account_number = #{payee.accountNumber},
                net_amount = #{netAmount},
                service_fee_amount = #{serviceFeeAmount},
                service_fee = #{serviceFee},
                <include refid="StoredEntityMapper.update"/>
            where df_usage_uid = #{id}
        )
        update ${schema}.df_usage_fas
        set
            is_rh_participating_flag = #{rhParticipating},
            is_payee_participating_flag = #{payeeParticipating},
            <include refid="StoredEntityMapper.update"/>
        where df_usage_fas_uid = #{id}
    </update>

    <update id="updateResearchedUsage" parameterType="map">
        update ${schema}.df_usage
        set
            standard_number = #{usage.standardNumber},
            standard_number_type = #{usage.standardNumberType},
            system_title = #{usage.systemTitle},
            wr_wrk_inst = #{usage.wrWrkInst},
            status_ind = #{status},
            <include refid="StoredEntityMapper.update"/>
        where df_usage_uid = #{usage.usageId}
    </update>

    <select id="updateProcessedUsage" parameterType="map" resultType="string">
        update ${schema}.df_usage
        set
            rh_account_number = #{rightsholder.accountNumber},
            wr_wrk_inst = #{wrWrkInst},
            system_title = #{systemTitle},
            work_title = #{workTitle},
            status_ind = #{status},
            product_family = #{productFamily},
            standard_number = #{standardNumber},
            standard_number_type = #{standardNumberType},
            <include refid="StoredEntityMapper.update"/>
        where df_usage_uid = #{id}
            and record_version = #{version}
        returning df_usage_uid
    </select>

    <select id="updateProcessedAaclUsage" parameterType="map" resultType="string">
        with u as (
            update ${schema}.df_usage_aacl
            set
                right_limitation = #{aaclUsage.rightLimitation},
                <include refid="StoredEntityMapper.update"/>
            where df_usage_aacl_uid = #{id}
        )
        update ${schema}.df_usage
        set
            status_ind = #{status},
            rh_account_number = #{rightsholder.accountNumber},
            system_title = #{systemTitle},
            standard_number = #{standardNumber},
            standard_number_type = #{standardNumberType},
            <include refid="StoredEntityMapper.update"/>
        where df_usage_uid = #{id}
            and record_version = #{version}
        returning df_usage_uid
    </select>

    <select id="isValidUsagesState" parameterType="map" resultType="boolean">
        select not exists (
            select 1
            from ${schema}.df_usage u
            join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
            left join ${schema}.df_rightsholder rro on rro.rh_account_number = ub.rro_account_number
            <include refid="usageFilter"/>
                and u.df_scenario_uid is null
                and u.status_ind != #{status})
    </select>

    <select id="insertNtsUsages" parameterType="map" resultType="string">
        with nts_usages as (
            select
                uuid_generate_v4() df_usage_uid,
                #{batchId} df_usage_batch_uid,
                ua.wr_wrk_inst,
                work_title,
                system_title,
                'WORK_FOUND' status_ind,
                'NTS' product_family,
                standard_number,
                standard_number_type,
                ufas.market,
                ufas.market_period_from,
                ufas.market_period_to,
                gross_amount reported_value,
                comment,
                <include refid="StoredEntityMapper.insert"/>
            from ${schema}.df_usage_archive ua
            join ${schema}.df_usage_fas ufas on ua.df_usage_archive_uid = ufas.df_usage_fas_uid
            left join ${schema}.df_work_classification wc on ua.wr_wrk_inst = wc.wr_wrk_inst
            <include refid="IUsageArchiveMapper.ntsBatchWhereClause"/>
                <if test="0 == stmAmount">
                    and (wc.classification = 'NON-STM' or wc.classification is null)
                </if>
                <if test="0 == nonStmAmount">
                    and (wc.classification = 'STM' or wc.classification is null)
                </if>
        ),
        <!--cutoff amounts for classified works - STM and NON-STM-->
        cutoff_amounts as (
            select
                'STM' classification,
                case when sum(u.reported_value *
                    (#{fundPoolPeriodDividend} / (u.market_period_to - u.market_period_from + 1))) is not null
                then round(#{stmMinAmount} * sum(u.reported_value *
                    (#{fundPoolPeriodDividend} / (u.market_period_to - u.market_period_from + 1))) / #{stmAmount}, 2)
                else 0.00 end cutoff_amount
            from nts_usages u
            join ${schema}.df_work_classification wc on u.wr_wrk_inst = wc.wr_wrk_inst
            where classification = 'STM'
            union
            select
                'NON-STM' classification,
                case when sum(u.reported_value *
                    (#{fundPoolPeriodDividend} / (u.market_period_to - u.market_period_from + 1))) is not null
                then round(#{nonStmMinAmount} * sum(u.reported_value *
                    (#{fundPoolPeriodDividend} / (u.market_period_to - u.market_period_from + 1))) / #{nonStmAmount}, 2)
                else 0.00 end cutoff_amount
            from nts_usages u
            join ${schema}.df_work_classification wc on u.wr_wrk_inst = wc.wr_wrk_inst
            where classification = 'NON-STM'
        ),
        <!--cutoff amount for unclassified works as minimum of STM and NON-STM-->
        unclassified_cutoff_amount as (
            select greatest(
                (select cutoff_amount from cutoff_amounts where classification = 'STM'),
                (select cutoff_amount from cutoff_amounts where classification = 'NON-STM')) unclassified_cutoff
        ),
        <!--total works weight-->
        work_total_weight_subquery as (
            select u.wr_wrk_inst,
                wc.classification,
                sum(u.reported_value *
                    (#{fundPoolPeriodDividend} / (u.market_period_to - u.market_period_from +1))) work_total_weight
            from nts_usages u
            left join ${schema}.df_work_classification wc on u.wr_wrk_inst = wc.wr_wrk_inst
            group by u.wr_wrk_inst, wc.classification
        ),
        usage_ids as (
            insert into ${schema}.df_usage (
                df_usage_uid,
                df_usage_batch_uid,
                wr_wrk_inst,
                work_title,
                system_title,
                status_ind,
                product_family,
                standard_number,
                standard_number_type,
                comment,
                <include refid="StoredEntityMapper.additionalColumns"/>
            )
            select
                ua.df_usage_uid,
                ua.df_usage_batch_uid,
                ua.wr_wrk_inst,
                ua.work_title,
                ua.system_title,
                ua.status_ind,
                ua.product_family,
                ua.standard_number,
                ua.standard_number_type,
                ua.comment,
                <include refid="StoredEntityMapper.insert"/>
            from nts_usages ua
            join work_total_weight_subquery sub on sub.wr_wrk_inst = ua.wr_wrk_inst
            where ((sub.work_total_weight &gt;= (select cutoff_amount from cutoff_amounts c where c.classification = sub.classification))
                or (sub.classification is null and sub.work_total_weight &gt;= (select unclassified_cutoff from unclassified_cutoff_amount)))
            returning df_usage_uid
        )
        insert into ${schema}.df_usage_fas (
            df_usage_fas_uid,
            market,
            market_period_from,
            market_period_to,
            reported_value,
            <include refid="StoredEntityMapper.additionalColumns"/>
        )
        select
            df_usage_uid,
            market,
            market_period_from,
            market_period_to,
            reported_value,
            <include refid="StoredEntityMapper.insert"/>
        from nts_usages
        where df_usage_uid::text in (select df_usage_uid from usage_ids)
        returning df_usage_fas_uid
    </select>

    <update id="calculateAmountsAndUpdatePayeeByAccountNumber" parameterType="map">
        with u as (
            update ${schema}.df_usage
            set
                payee_account_number = #{payeeAccountNumber},
                service_fee = #{serviceFee},
                service_fee_amount = gross_amount * #{serviceFee},
                net_amount = gross_amount - (gross_amount * #{serviceFee}),
                <include refid="StoredEntityMapper.update"/>
            where rh_account_number = #{rhAccountNumber}
                and df_scenario_uid = #{scenarioId}
            returning df_usage_uid
        )
        update ${schema}.df_usage_fas
        set
            is_rh_participating_flag = #{rhParticipating},
            <include refid="StoredEntityMapper.update"/>
        from u
        where df_usage_fas_uid = u.df_usage_uid
    </update>

    <update id="addWithdrawnUsagesToPreServiceFeeFund" parameterType="map">
        with u as (
            update ${schema}.df_usage
            set
                status_ind = #{statusToSet},
                <include refid="StoredEntityMapper.update"/>
            where df_usage_batch_uid in
                <foreach collection="batchIds" item="batchId" separator="," open="(" close=")">
                    #{batchId}
                </foreach>
                and status_ind = #{statusToFind}
            returning df_usage_uid
        )
        update ${schema}.df_usage_fas
        set
            df_fund_pool_uid = #{fundId},
            <include refid="StoredEntityMapper.update"/>
        from u
        where df_usage_fas_uid = u.df_usage_uid
    </update>

    <update id="updateUsagesStatusToUnclassified" parameterType="map">
        update ${schema}.df_usage
        set
            status_ind = #{statusToSet},
            <include refid="StoredEntityMapper.update"/>
        where wr_wrk_inst in
            <foreach collection="wrWrkInsts" item="wrWrkInst" separator="," open="(" close=")">
                #{wrWrkInst}
            </foreach>
            and status_ind = #{statusToFind}
            and product_family = #{productFamily}
    </update>

    <select id="findWrWrkInstToUsageIdsByBatchNameAndUsageStatus" resultMap="wrWrkInstToUsageIdResultMap">
        select u.df_usage_uid,
            u.wr_wrk_inst
        from ${schema}.df_usage u
        join ${schema}.df_usage_batch ub on ub.df_usage_batch_uid = u.df_usage_batch_uid
        where ub.name = #{batchName} and u.status_ind = #{status}
            and u.wr_wrk_inst is not null
    </select>

    <update id="applyPostServiceFeeAmount" parameterType="string">
        <!-- Calculates scenario net amount totals-->
        with net_amount_totals as (
            select sum(net_amount) net_amount_total
            from ${schema}.df_usage u
            where df_scenario_uid = #{scenarioId}
        ),
        <!-- Calculate GT factor based on scenario net totals and Post Service Fee Amount -->
        gt_factor as (
            select
                ((select net_amount_total from net_amount_totals) + (s.nts_fields->>'post_service_fee_amount')::numeric)
                    / (select net_amount_total from net_amount_totals) net_amount_gt_factor
            from ${schema}.df_scenario s
            where df_scenario_uid = #{scenarioId}
        )
        <!-- Proportionally distributes Post Service Fee Amount among scenario usages -->
        update
            ${schema}.df_usage u
        set
            net_amount = u.net_amount * net_amount_gt_factor,
            gross_amount = u.net_amount * net_amount_gt_factor + u.service_fee_amount
        from gt_factor
        where u.df_scenario_uid = #{scenarioId}
    </update>

    <select id="findReferencedFasUsagesCountByIds" resultType="int" parameterType="list">
        select count(1)
            from ${schema}.df_usage_fas
        where df_usage_fas_uid in
        <foreach collection="usageIds" item="usageId" open="(" separator="," close=")">
            #{usageId}
        </foreach>
    </select>

    <select id="findAaclUsagePeriods" resultType="int">
        select
            distinct usage_period
        from ${schema}.df_usage_aacl
        order by usage_period
    </select>
</mapper>
