<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="IAaclUsageMapper">

    <resultMap id="aaclUsageResultMap" type="Usage" extends="StoredEntityMapper.storedEntityResult">
        <result property="id" column="df_usage_uid"/>
        <result property="batchId" column="df_usage_batch_uid"/>
        <result property="scenarioId" column="df_scenario_uid"/>
        <result property="status" column="status_ind"/>
        <result property="productFamily" column="product_family"/>
        <result property="wrWrkInst" column="wr_wrk_inst"/>
        <result property="rightsholder.id" column="rh_id"/>
        <result property="rightsholder.accountNumber" column="rh_account_number"/>
        <result property="rightsholder.name" column="rh_name"/>
        <result property="systemTitle" column="system_title"/>
        <result property="standardNumber" column="standard_number"/>
        <result property="standardNumberType" column="standard_number_type"/>
        <result property="numberOfCopies" column="number_of_copies"/>
        <result property="grossAmount" column="gross_amount"/>
        <result property="serviceFeeAmount" column="service_fee_amount"/>
        <result property="netAmount" column="net_amount"/>
        <result property="serviceFee" column="service_fee"/>
        <result property="comment" column="comment"/>
        <result property="aaclUsage.institution" column="institution"/>
        <result property="aaclUsage.usageAge.period" column="usage_period"/>
        <result property="aaclUsage.usageSource" column="usage_source"/>
        <result property="aaclUsage.numberOfPages" column="number_of_pages"/>
        <result property="aaclUsage.rightLimitation" column="right_limitation"/>
        <result property="aaclUsage.batchPeriodEndDate" column="batch_period_end_date"/>
        <result property="aaclUsage.detailLicenseeClass.id" column="detail_licensee_class_id"/>
        <result property="aaclUsage.detailLicenseeClass.discipline" column="detail_licensee_discipline"/>
        <result property="aaclUsage.detailLicenseeClass.enrollmentProfile" column="detail_licensee_enrollment"/>
        <result property="aaclUsage.publicationType.id" column="pub_type_id"/>
        <result property="aaclUsage.publicationType.name" column="pub_type_name"/>
        <result property="aaclUsage.publicationType.weight" column="publication_type_weight"/>
        <result property="aaclUsage.originalPublicationType" column="original_publication_type"/>
        <result property="aaclUsage.baselineId" column="baseline_uid"/>
        <result property="aaclUsage.volumeWeight" column="volume_weight"/>
        <result property="aaclUsage.valueWeight" column="value_weight"/>
        <result property="aaclUsage.volumeShare" column="volume_share"/>
        <result property="aaclUsage.valueShare" column="value_share"/>
        <result property="aaclUsage.totalShare" column="total_share"/>
    </resultMap>

    <resultMap id="aaclUsageDtoResultMap" type="UsageDto" extends="StoredEntityMapper.storedEntityResult">
        <result property="id" column="df_usage_uid"/>
        <result property="batchName" column="batch_name"/>
        <result property="status" column="status_ind"/>
        <result property="productFamily" column="product_family"/>
        <result property="wrWrkInst" column="wr_wrk_inst"/>
        <result property="rhAccountNumber" column="rh_account_number"/>
        <result property="rhName" column="rh_name"/>
        <result property="grossAmount" column="gross_amount"/>
        <result property="serviceFeeAmount" column="service_fee_amount"/>
        <result property="netAmount" column="net_amount"/>
        <result property="serviceFee" column="service_fee"/>
        <result property="payeeAccountNumber" column="payee_account_number"/>
        <result property="payeeName" column="payee_name"/>
        <result property="periodEndDate" column="period_end_date"/>
        <result property="scenarioName" column="scenario_name"/>
        <result property="checkNumber" column="check_number"/>
        <result property="checkDate" column="check_date"/>
        <result property="cccEventId" column="ccc_event_id"/>
        <result property="distributionName" column="distribution_name"/>
        <result property="distributionDate" column="distribution_date"/>
        <result property="systemTitle" column="system_title"/>
        <result property="standardNumber" column="standard_number"/>
        <result property="standardNumberType" column="standard_number_type"/>
        <result property="numberOfCopies" column="number_of_copies"/>
        <result property="comment" column="comment"/>
        <result property="aaclUsage.institution" column="institution"/>
        <result property="aaclUsage.usageAge.period" column="usage_period"/>
        <result property="aaclUsage.usageAge.weight" column="usage_age_weight"/>
        <result property="aaclUsage.usageSource" column="usage_source"/>
        <result property="aaclUsage.numberOfPages" column="number_of_pages"/>
        <result property="aaclUsage.rightLimitation" column="right_limitation"/>
        <result property="aaclUsage.batchPeriodEndDate" column="batch_period_end_date"/>
        <result property="aaclUsage.detailLicenseeClass.id" column="detail_licensee_class_id"/>
        <result property="aaclUsage.detailLicenseeClass.discipline" column="detail_licensee_discipline"/>
        <result property="aaclUsage.detailLicenseeClass.enrollmentProfile" column="detail_licensee_enrollment"/>
        <result property="aaclUsage.aggregateLicenseeClass.id" column="aggregate_licensee_class_id"/>
        <result property="aaclUsage.aggregateLicenseeClass.discipline" column="aggregate_licensee_discipline"/>
        <result property="aaclUsage.aggregateLicenseeClass.enrollmentProfile" column="aggregate_licensee_enrollment"/>
        <result property="aaclUsage.publicationType.id" column="pub_type_id"/>
        <result property="aaclUsage.publicationType.name" column="pub_type_name"/>
        <result property="aaclUsage.publicationType.weight" column="publication_type_weight"/>
        <result property="aaclUsage.originalPublicationType" column="original_publication_type"/>
        <result property="aaclUsage.baselineId" column="baseline_uid"/>
    </resultMap>

    <resultMap id="payeeTotalHolderResultMap" type="PayeeTotalHolder">
        <result property="payee.name" column="payee_name"/>
        <result property="payee.accountNumber" column="payee_account_number"/>
        <result property="grossTotal" column="gross_total"/>
        <result property="serviceFeeTotal" column="service_fee_total"/>
        <result property="netTotal" column="net_total"/>
    </resultMap>

    <resultMap id="payeeAggLicenseeClassesPairResultMap" type="PayeeAccountAggregateLicenseeClassesPair">
        <result property="payeeAccountNumber" column="payee_account_number"/>
        <collection property="aggregateLicenseeClasses" javaType="java.util.Set" resultMap="aggregateLicenseeClass"/>
    </resultMap>

    <resultMap id="aggregateLicenseeClass" type="AggregateLicenseeClass">
        <result property="id" column="aggregate_licensee_class_id"/>
        <result property="discipline" column="discipline"/>
        <result property="enrollmentProfile" column="enrollment_profile"/>
    </resultMap>

    <sql id="aaclUsageColumns">
        u.df_usage_batch_uid,
        u.df_scenario_uid,
        u.wr_wrk_inst,
        u.system_title,
        u.standard_number,
        u.standard_number_type,
        u.rh_account_number,
        rh.name rh_name,
        rh.df_rightsholder_uid rh_id,
        u.status_ind,
        u.product_family,
        u.number_of_copies,
        u.gross_amount,
        u.service_fee_amount,
        u.net_amount,
        u.service_fee,
        u.comment,
        ub.payment_date batch_period_end_date,
        uaacl.institution,
        uaacl.usage_period,
        uaacl.usage_source,
        uaacl.number_of_pages,
        uaacl.right_limitation,
        uaacl.detail_licensee_class_id,
        uaacl.baseline_uid,
        uaacl.volume_weight,
        uaacl.value_weight,
        uaacl.volume_share,
        uaacl.value_share,
        uaacl.total_share,
        dlc.discipline detail_licensee_discipline,
        dlc.enrollment_profile detail_licensee_enrollment,
        uaacl.original_publication_type,
        pt.df_publication_type_uid pub_type_id,
        pt.name pub_type_name,
        uaacl.publication_type_weight,
        u.created_datetime,
        u.updated_datetime,
        u.created_by_user,
        u.updated_by_user,
        u.record_version
    </sql>

    <sql id="selectCountForAuditSql">
        select
        <choose>
            <when test="null != filter.cccEventId || null != filter.distributionName">
                <include refid="IAaclUsageMapper.selectArchivedCountForAuditSql"/>
            </when>
            <otherwise>
                (select count(1) usage_count
                from ${schema}.df_usage u
                join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
                join ${schema}.df_usage_batch ub on ub.df_usage_batch_uid = u.df_usage_batch_uid
                left join ${schema}.df_scenario s on s.df_scenario_uid = u.df_scenario_uid
                <where>
                    <include refid="IAaclUsageMapper.aaclAuditFilterWhereClause">
                        <property name="detail_uid" value="u.df_usage_uid"/>
                    </include>
                </where>) +
                <include refid="IAaclUsageMapper.selectArchivedCountForAuditSql"/>
            </otherwise>
        </choose>
    </sql>

    <sql id="selectArchivedCountForAuditSql">
        (select count(1) usage_count
        from ${schema}.df_usage_archive u
        join ${schema}.df_usage_aacl uaacl on u.df_usage_archive_uid = uaacl.df_usage_aacl_uid
        left join ${schema}.df_usage_batch ub on ub.df_usage_batch_uid = u.df_usage_batch_uid
        left join ${schema}.df_scenario s on s.df_scenario_uid = u.df_scenario_uid
        <include refid="IAaclUsageMapper.archivedAaclAuditFilterWhereClause"/>)
    </sql>

    <sql id="selectForAuditSql">
        <choose>
            <when test="null != filter.cccEventId || null != filter.distributionName">
                <include refid="IAaclUsageMapper.selectArchivedUsagesForAuditSql"/>
            </when>
            <otherwise>
                select
                    u.df_usage_uid,
                    u.status_ind,
                    u.product_family,
                    u.df_usage_batch_uid,
                    ub.name batch_name,
                    ub.payment_date batch_period_end_date,
                    u.rh_account_number,
                    rh.name rh_name,
                    u.payee_account_number,
                    payee.name payee_name,
                    wr_wrk_inst,
                    system_title,
                    standard_number,
                    standard_number_type,
                    u.gross_amount,
                    u.net_amount,
                    service_fee_amount,
                    u.updated_datetime,
                    s.name scenario_name,
                    null check_number,
                    null check_date,
                    null ccc_event_id,
                    null distribution_name,
                    null distribution_date,
                    null period_end_date,
                    u.comment,
                    uaacl.baseline_uid,
                    uaacl.usage_period,
                    uaacl.usage_source,
                    uaacl.number_of_pages,
                    uaacl.detail_licensee_class_id,
                    pt.name pub_type_name,
                    dlc.discipline detail_licensee_discipline,
                    dlc.enrollment_profile detail_licensee_enrollment
                from ${schema}.df_usage u
                join ${schema}.df_usage_batch ub on ub.df_usage_batch_uid = u.df_usage_batch_uid
                left join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
                left join ${schema}.df_publication_type pt on uaacl.df_publication_type_uid = pt.df_publication_type_uid
                left join ${schema}.df_detail_licensee_class dlc on uaacl.detail_licensee_class_id = dlc.detail_licensee_class_id
                left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
                left join ${schema}.df_rightsholder payee on payee.rh_account_number = u.payee_account_number
                left join ${schema}.df_scenario s on s.df_scenario_uid = u.df_scenario_uid
                <where>
                    <include refid="IAaclUsageMapper.aaclAuditFilterWhereClause">
                        <property name="detail_uid" value="u.df_usage_uid"/>
                    </include>
                </where>
                union
                <include refid="IAaclUsageMapper.selectArchivedUsagesForAuditSql"/>
            </otherwise>
        </choose>
        order by
        <choose>
            <when test="null != sort">
                <choose>
                    <when test="sort.property == 'detailId'">
                        df_usage_uid
                    </when>
                    <when test="sort.property == 'baselineId'">
                        baseline_uid
                    </when>
                    <when test="sort.property == 'status'">
                        status_ind
                    </when>
                    <when test="sort.property == 'productFamily'">
                        product_family
                    </when>
                    <when test="sort.property == 'batchName'">
                        batch_name
                    </when>
                    <when test="sort.property == 'batchPeriodEndDate'">
                        batch_period_end_date
                    </when>
                    <when test="sort.property == 'rhAccountNumber'">
                        rh_account_number
                    </when>
                    <when test="sort.property == 'rhName'">
                        rh_name
                    </when>
                    <when test="sort.property == 'payeeAccountNumber'">
                        payee_account_number
                    </when>
                    <when test="sort.property == 'payeeName'">
                        payee_name
                    </when>
                    <when test="sort.property == 'wrWrkInst'">
                        wr_wrk_inst
                    </when>
                    <when test="sort.property == 'systemTitle'">
                        system_title
                    </when>
                    <when test="sort.property == 'standardNumber'">
                        standard_number
                    </when>
                    <when test="sort.property == 'standardNumberType'">
                        standard_number_type
                    </when>
                    <when test="sort.property == 'grossAmount'">
                        gross_amount
                    </when>
                    <when test="sort.property == 'serviceFeeAmount'">
                        service_fee_amount
                    </when>
                    <when test="sort.property == 'netAmount'">
                        net_amount
                    </when>
                    <when test="sort.property == 'scenarioName'">
                        scenario_name
                    </when>
                    <when test="sort.property == 'checkNumber'">
                        check_number
                    </when>
                    <when test="sort.property == 'checkDate'">
                        check_date
                    </when>
                    <when test="sort.property == 'cccEventId'">
                        ccc_event_id
                    </when>
                    <when test="sort.property == 'distributionName'">
                        distribution_name
                    </when>
                    <when test="sort.property == 'distributionDate'">
                        distribution_date
                    </when>
                    <when test="sort.property == 'detailLicenseeClassId'">
                        detail_licensee_class_id
                    </when>
                    <when test="sort.property == 'enrollmentProfile'">
                        detail_licensee_enrollment
                    </when>
                    <when test="sort.property == 'discipline'">
                        detail_licensee_discipline
                    </when>
                    <when test="sort.property == 'publicationType'">
                        pub_type_name
                    </when>
                    <when test="sort.property == 'usagePeriod'">
                        usage_period
                    </when>
                    <when test="sort.property == 'usageSource'">
                        usage_source
                    </when>
                    <when test="sort.property == 'comment'">
                        comment
                    </when>
                </choose>
                <include refid="IUsageMapper.direction"/>,
                df_usage_uid
            </when>
            <otherwise>
                df_usage_uid
            </otherwise>
        </choose>
        <include refid="IUsageMapper.ifPageable"/>
    </sql>

    <sql id="selectArchivedUsagesForAuditSql">
        select
            df_usage_archive_uid df_usage_uid,
            u.status_ind,
            u.product_family,
            u.df_usage_batch_uid,
            ub.name batch_name,
            ub.payment_date batch_period_end_date,
            u.rh_account_number,
            rh.name rh_name,
            u.payee_account_number,
            payee.name payee_name,
            wr_wrk_inst,
            system_title,
            standard_number,
            standard_number_type,
            u.gross_amount,
            u.net_amount,
            service_fee_amount,
            u.updated_datetime,
            s.name scenario_name,
            u.check_number,
            u.check_date,
            u.ccc_event_id,
            u.distribution_name,
            u.distribution_date,
            u.period_end_date,
            u.comment,
            uaacl.baseline_uid,
            uaacl.usage_period,
            uaacl.usage_source,
            uaacl.number_of_pages,
            uaacl.detail_licensee_class_id,
            pt.name pub_type_name,
            dlc.discipline detail_licensee_discipline,
            dlc.enrollment_profile detail_licensee_enrollment
        from ${schema}.df_usage_archive u
        join ${schema}.df_usage_aacl uaacl on u.df_usage_archive_uid = uaacl.df_usage_aacl_uid
        left join ${schema}.df_usage_batch ub on ub.df_usage_batch_uid = u.df_usage_batch_uid
        left join ${schema}.df_publication_type pt on uaacl.df_publication_type_uid = pt.df_publication_type_uid
        left join ${schema}.df_detail_licensee_class dlc on uaacl.detail_licensee_class_id = dlc.detail_licensee_class_id
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        left join ${schema}.df_rightsholder payee on payee.rh_account_number = u.payee_account_number
        left join ${schema}.df_scenario s on s.df_scenario_uid = u.df_scenario_uid
        <include refid="IAaclUsageMapper.archivedAaclAuditFilterWhereClause"/>
    </sql>

    <sql id="archivedAaclAuditFilterWhereClause">
        <where>
            <include refid="IAaclUsageMapper.aaclAuditFilterWhereClause">
                <property name="detail_uid" value="u.df_usage_archive_uid"/>
            </include>
            <if test="null != filter.cccEventId">
                and ccc_event_id ilike #{filter.cccEventId}
            </if>
            <if test="null != filter.distributionName">
                and distribution_name ilike #{filter.distributionName}
            </if>
        </where>
    </sql>

    <sql id="aaclAuditFilterWhereClause">
        <if test="!filter.rhAccountNumbers.isEmpty()">
            u.rh_account_number in
            <foreach collection="filter.rhAccountNumbers" item="accountNumber" separator="," open="(" close=")">
                #{accountNumber}
            </foreach>
        </if>
        <if test="!filter.batchesIds.isEmpty()">
            and ub.df_usage_batch_uid in
            <foreach collection="filter.batchesIds" item="batchId" separator="," open="(" close=")">
                #{batchId}
            </foreach>
        </if>
        <if test="!filter.statuses.isEmpty()">
            and u.status_ind in
            <foreach collection="filter.statuses" item="status" separator="," open="(" close=")">
                #{status}
            </foreach>
        </if>
        <if test="null != filter.productFamily">
            and u.product_family = #{filter.productFamily}
        </if>
        <if test="null != filter.usagePeriod">
            and uaacl.usage_period = #{filter.usagePeriod}
        </if>
        <if test="null != filter.searchValue">
            and (
            ${detail_uid} like '%' || #{filter.searchValue} || '%' or
            cast(wr_wrk_inst as text) like '%' || #{filter.searchValue} || '%' or
            system_title ilike '%' || #{filter.searchValue} || '%')
        </if>
    </sql>

    <sql id="aaclUsageFilter">
        <where>
            <if test="filter.usageBatchesIds.size() > 0">
                and
                <foreach collection="filter.usageBatchesIds" item="usageBatchId" open="(" separator=" or " close=")">
                    u.df_usage_batch_uid = #{usageBatchId}
                </foreach>
            </if>
            <if test="null != filter.productFamily">
                and u.product_family = #{filter.productFamily}
            </if>
            <if test="null != filter.usageStatus">
                and u.status_ind = #{filter.usageStatus}
            </if>
            <if test="null != filter.usagePeriod">
                and uaacl.usage_period = #{filter.usagePeriod}
            </if>
        </where>
    </sql>

    <sql id="aaclChooseSortProperty">
        <choose>
            <when test="sort.property == 'detailId'">
                ${detail_uid} <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'status'">
                u.status_ind <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'productFamily'">
                u.product_family <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'batchName'">
                ub.name <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'periodEndDate'">
                ub.payment_date <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'rhAccountNumber'">
                u.rh_account_number <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'rhName'">
                rh.name <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'wrWrkInst'">
                u.wr_wrk_inst <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'systemTitle'">
                u.system_title <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'standardNumber'">
                u.standard_number <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'standardNumberType'">
                u.standard_number_type <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'institution'">
                uaacl.institution <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'usagePeriod'">
                uaacl.usage_period <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'usageSource'">
                uaacl.usage_source <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'numberOfCopies'">
                u.number_of_copies <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'numberOfPages'">
                uaacl.number_of_pages <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'rightLimitation'">
                uaacl.right_limitation <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'comment'">
                u.comment <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'publicationType'">
                pt.name <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'publicationTypeWeight'">
                uaacl.publication_type_weight <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'originalPublicationType'">
                uaacl.original_publication_type <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'usagePeriod'">
                uaacl.usage_period <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'usageAgeWeight'">
                usage_age_weight <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'detailLicenseeClassId'">
                uaacl.detail_licensee_class_id <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'detailLicenseeDiscipline'">
                detail_licensee_discipline <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'detailLicenseeEnrollment'">
                detail_licensee_enrollment <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'aggregateLicenseeClassId'">
                aggregate_licensee_class_id <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'aggregateLicenseeDiscipline'">
                aggregate_licensee_discipline <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'aggregateLicenseeEnrollment'">
                aggregate_licensee_enrollment <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'grossAmount'">
                u.gross_amount <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'serviceFeeAmount'">
                u.service_fee_amount <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'serviceFee'">
                u.service_fee <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'netAmount'">
                u.net_amount <include refid="IUsageMapper.direction"/>
            </when>
        </choose>
    </sql>

    <sql id="selectDtosByFilterSql">
        select
            u.df_usage_uid,
            <include refid="IAaclUsageMapper.aaclUsageColumns"/>,
            ub.name batch_name
        from ${schema}.df_usage u
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
        left join ${schema}.df_publication_type pt on uaacl.df_publication_type_uid = pt.df_publication_type_uid
        left join ${schema}.df_detail_licensee_class dlc on uaacl.detail_licensee_class_id = dlc.detail_licensee_class_id
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        <include refid="IAaclUsageMapper.aaclUsageFilter"/>
            and u.df_scenario_uid is null
        order by
        <choose>
            <when test="null != sort">
                <include refid="IAaclUsageMapper.aaclChooseSortProperty">
                    <property name="detail_uid" value="u.df_usage_uid"/>
                </include>
            </when>
            <otherwise>
                updated_datetime desc
            </otherwise>
        </choose>,
        df_usage_uid
        <include refid="IUsageMapper.ifPageable"/>
    </sql>

    <sql id="selectCountByFilterSql">
        select count(1)
        from ${schema}.df_usage u
        join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
        <include refid="IAaclUsageMapper.aaclUsageFilter"/>
            and u.df_scenario_uid is null
    </sql>

    <sql id="selectUsageDtos">
        select
            u.df_usage_uid,
            <include refid="IAaclUsageMapper.aaclUsageColumns"/>,
            u.payee_account_number,
            p.name payee_name,
            ub.name batch_name,
            alc.aggregate_licensee_class_id,
            alc.discipline aggregate_licensee_discipline,
            alc.enrollment_profile aggregate_licensee_enrollment,
            (usageAges ->> 'weight')::text usage_age_weight
        from ${schema}.df_usage u
        join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_publication_type pt on uaacl.df_publication_type_uid = pt.df_publication_type_uid
        left join ${schema}.df_detail_licensee_class dlc on uaacl.detail_licensee_class_id = dlc.detail_licensee_class_id
        left join ${schema}.df_scenario s on u.df_scenario_uid = s.df_scenario_uid
        left join jsonb_array_elements(s.aacl_fields -> 'usageAges') usageAges on (usageAges ->> 'period')::int = uaacl.usage_period
        left join jsonb_array_elements(s.aacl_fields -> 'detailLicenseeClasses') detailLicenseeClasses
            on (detailLicenseeClasses ->> 'detailLicenseeClassId')::int = dlc.detail_licensee_class_id
        left join ${schema}.df_aggregate_licensee_class alc
            on (detailLicenseeClasses ->> 'aggregateLicenseeClassId')::int = alc.aggregate_licensee_class_id
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        left join ${schema}.df_rightsholder p on p.rh_account_number = u.payee_account_number
    </sql>

    <sql id="selectArchivedDtoByScenarioIdSql">
        select
            u.df_usage_archive_uid df_usage_uid,
            <include refid="IAaclUsageMapper.aaclUsageColumns"/>,
            u.payee_account_number,
            p.name payee_name,
            ub.name batch_name,
            alc.aggregate_licensee_class_id,
            alc.discipline aggregate_licensee_discipline,
            alc.enrollment_profile aggregate_licensee_enrollment,
            (usageAges ->> 'weight')::text usage_age_weight
        from ${schema}.df_usage_archive u
        join ${schema}.df_usage_aacl uaacl on u.df_usage_archive_uid = uaacl.df_usage_aacl_uid
        left join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_publication_type pt on uaacl.df_publication_type_uid = pt.df_publication_type_uid
        left join ${schema}.df_detail_licensee_class dlc on uaacl.detail_licensee_class_id = dlc.detail_licensee_class_id
        left join ${schema}.df_scenario s on u.df_scenario_uid = s.df_scenario_uid
        left join jsonb_array_elements(s.aacl_fields -> 'usageAges') usageAges on (usageAges ->> 'period')::int = uaacl.usage_period
        left join jsonb_array_elements(s.aacl_fields -> 'detailLicenseeClasses') detailLicenseeClasses
            on (detailLicenseeClasses ->> 'detailLicenseeClassId')::int = dlc.detail_licensee_class_id
        left join ${schema}.df_aggregate_licensee_class alc
            on (detailLicenseeClasses ->> 'aggregateLicenseeClassId')::int = alc.aggregate_licensee_class_id
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        left join ${schema}.df_rightsholder p on p.rh_account_number = u.payee_account_number
        where s.df_scenario_uid = #{scenarioId}
        order by u.rh_account_number, u.df_usage_archive_uid
            <include refid="IUsageMapper.ifPageable"/>
    </sql>

    <select id="findDtosByFilter" resultMap="aaclUsageDtoResultMap" parameterType="map" fetchSize="${usageSelectFetchSize}">
        <include refid="IAaclUsageMapper.selectDtosByFilterSql"/>
    </select>

    <select id="findForAudit" resultMap="aaclUsageDtoResultMap" parameterType="map">
        <include refid="IAaclUsageMapper.selectForAuditSql"/>
    </select>

    <select id="findCountForAudit" resultType="int" parameterType="map">
        <include refid="IAaclUsageMapper.selectCountForAuditSql"/>
    </select>

    <select id="findCountByFilter" parameterType="map" resultType="int">
        <include refid="IAaclUsageMapper.selectCountByFilterSql"/>
    </select>

    <insert id="insert" parameterType="Usage">
        with u as (
            insert into ${schema}.df_usage (
                df_usage_uid,
                df_usage_batch_uid,
                wr_wrk_inst,
                system_title,
                standard_number,
                standard_number_type,
                rh_account_number,
                status_ind,
                product_family,
                number_of_copies,
                comment,
                <include refid="StoredEntityMapper.additionalColumns"/>
            )
            values (
                #{id},
                #{batchId},
                #{wrWrkInst},
                #{systemTitle},
                #{standardNumber},
                #{standardNumberType},
                #{rightsholder.accountNumber},
                #{status},
                #{productFamily},
                #{numberOfCopies},
                #{comment},
                <include refid="StoredEntityMapper.insert"/>
            )
        )
        insert into ${schema}.df_usage_aacl (
            df_usage_aacl_uid,
            institution,
            usage_period,
            usage_source,
            number_of_pages,
            right_limitation,
            <include refid="StoredEntityMapper.additionalColumns"/>
        )
        values (
            #{id},
            #{aaclUsage.institution},
            #{aaclUsage.usageAge.period},
            #{aaclUsage.usageSource},
            #{aaclUsage.numberOfPages},
            #{aaclUsage.rightLimitation},
            <include refid="StoredEntityMapper.insert"/>
        )
    </insert>

    <select id="insertFromBaseline" parameterType="map" resultType="string">
        with baseline_usages as (
            select
                uuid_generate_v4() df_usage_uid,
                #{batchId} df_usage_batch_uid,
                wr_wrk_inst,
                'NEW' status_ind,
                'AACL' product_family,
                usage_period,
                usage_source,
                number_of_copies,
                number_of_pages,
                detail_licensee_class_id,
                original_publication_type,
                df_publication_type_uid,
                publication_type_weight,
                institution,
                comment,
                df_usage_baseline_aacl_uid
            from ${schema}.df_usage_baseline_aacl
            where usage_period in
            <foreach collection="periods" item="period" open="(" separator="," close=")">
                #{period}
            </foreach>
        ),
        u as (
            insert into ${schema}.df_usage (
                df_usage_uid,
                df_usage_batch_uid,
                wr_wrk_inst,
                status_ind,
                product_family,
                number_of_copies,
                comment,
                <include refid="StoredEntityMapper.additionalColumns"/>
            )
            select
                df_usage_uid,
                df_usage_batch_uid,
                wr_wrk_inst,
                status_ind,
                product_family,
                number_of_copies,
                comment,
                <include refid="StoredEntityMapper.insert"/>
            from baseline_usages
        )
        insert into ${schema}.df_usage_aacl (
            df_usage_aacl_uid,
            institution,
            usage_period,
            usage_source,
            number_of_pages,
            detail_licensee_class_id,
            original_publication_type,
            df_publication_type_uid,
            publication_type_weight,
            baseline_uid,
            <include refid="StoredEntityMapper.additionalColumns"/>
        )
        select
            df_usage_uid,
            institution,
            usage_period,
            usage_source,
            number_of_pages,
            detail_licensee_class_id,
            original_publication_type,
            df_publication_type_uid,
            publication_type_weight,
            df_usage_baseline_aacl_uid,
            <include refid="StoredEntityMapper.insert"/>
        from baseline_usages
        returning df_usage_aacl_uid
    </select>

    <select id="updateProcessedUsage" parameterType="map" resultType="string">
        with u as (
            update ${schema}.df_usage_aacl
            set
                right_limitation = #{aaclUsage.rightLimitation},
                <include refid="StoredEntityMapper.update"/>
            where df_usage_aacl_uid = #{id}
        )
        update ${schema}.df_usage
        set
            status_ind = #{status},
            rh_account_number = #{rightsholder.accountNumber},
            system_title = #{systemTitle},
            standard_number = #{standardNumber},
            standard_number_type = #{standardNumberType},
            <include refid="StoredEntityMapper.update"/>
        where df_usage_uid = #{id}
            and record_version = #{version}
        returning df_usage_uid
    </select>

    <delete id="deleteById" parameterType="string">
        with u as (
            delete from ${schema}.df_usage
            where df_usage_uid = #{usageId}
        )
        delete from ${schema}.df_usage_aacl
        where df_usage_aacl_uid = #{usageId}
    </delete>

    <select id="findByIds" resultMap="aaclUsageResultMap">
        select
            u.df_usage_uid,
            <include refid="IAaclUsageMapper.aaclUsageColumns"/>
        from ${schema}.df_usage u
        join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_publication_type pt on uaacl.df_publication_type_uid = pt.df_publication_type_uid
        left join ${schema}.df_detail_licensee_class dlc on uaacl.detail_licensee_class_id = dlc.detail_licensee_class_id
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        where u.df_usage_uid in
        <foreach collection="list" item="usageId" open="(" separator="," close=")">
            #{usageId}
        </foreach>
        order by u.df_usage_uid
    </select>

    <select id="findReferencedAaclUsagesCountByIds" resultType="int" parameterType="list">
        select count(1)
        from ${schema}.df_usage_aacl
        where df_usage_aacl_uid in
        <foreach collection="usageIds" item="usageId" open="(" separator="," close=")">
            #{usageId}
        </foreach>
    </select>

    <select id="findBaselinePeriods" parameterType="map" resultType="int">
        select distinct usage_period
        from ${schema}.df_usage_baseline_aacl
        where <![CDATA[usage_period <= #{startPeriod}]]>
        order by usage_period desc
        limit #{numberOfBaselineYears}
    </select>

    <select id="findUsagePeriods" resultType="int">
        select distinct usage_period
        from ${schema}.df_usage_aacl
        order by usage_period
    </select>

    <select id="findUsagePeriodsByFilter" parameterType="UsageFilter" resultType="int">
        select distinct uaacl.usage_period
        from ${schema}.df_usage u
        join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
        <include refid="IAaclUsageMapper.aaclUsageFilter"/>
        order by uaacl.usage_period desc
    </select>

    <select id="findByScenarioId" parameterType="string" resultMap="aaclUsageResultMap">
        select
            u.df_usage_uid,
            <include refid="IAaclUsageMapper.aaclUsageColumns"/>
        from ${schema}.df_usage u
        join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_publication_type pt on uaacl.df_publication_type_uid = pt.df_publication_type_uid
        left join ${schema}.df_detail_licensee_class dlc on uaacl.detail_licensee_class_id = dlc.detail_licensee_class_id
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        where u.df_scenario_uid = #{scenarioId}
    </select>

    <select id="isValidFilteredUsageStatus" parameterType="map" resultType="boolean">
        select not exists (
            select 1
            from ${schema}.df_usage u
            join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
            join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
            <include refid="IAaclUsageMapper.aaclUsageFilter"/>
                and u.df_scenario_uid is null
                and u.status_ind != #{status}
        )
    </select>

    <select id="isValidForClassification" parameterType="map" resultType="boolean">
        with usages_by_filter as (
            select
                uaacl.baseline_uid,
                u.status_ind
            from ${schema}.df_usage u
            join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
            join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
            <include refid="IAaclUsageMapper.aaclUsageFilter"/>
        )
        select exists (
            select 1
            from usages_by_filter
        ) and not exists (
            select 1
            from usages_by_filter ubf
            where ubf.status_ind != #{status}
                or (ubf.status_ind = #{status} and ubf.baseline_uid is not null)
        )
    </select>

    <update id="updateClassifiedUsage" parameterType="map">
        with u as (
            update ${schema}.df_usage
            set
                status_ind = #{status},
                wr_wrk_inst = #{aaclUsage.wrWrkInst},
                comment = #{aaclUsage.comment},
                <include refid="StoredEntityMapper.update"/>
            where df_usage_uid = #{aaclUsage.detailId}
        )
        update ${schema}.df_usage_aacl uaacl
        set
            detail_licensee_class_id = dlc.detail_licensee_class_id,
            df_publication_type_uid = pt.df_publication_type_uid,
            updated_by_user = #{updateUser},
            updated_datetime = now(),
            record_version = uaacl.record_version + 1
        from ${schema}.df_publication_type pt, ${schema}.df_detail_licensee_class dlc
        where df_usage_aacl_uid = #{aaclUsage.detailId}
            and pt.name ilike #{aaclUsage.publicationType}
            and dlc.enrollment_profile ilike #{aaclUsage.enrollmentProfile}
            and dlc.discipline ilike #{aaclUsage.discipline}
    </update>

    <update id="updatePayeeByAccountNumber" parameterType="map">
        update ${schema}.df_usage
        set
            payee_account_number = #{payeeAccountNumber},
            <include refid="StoredEntityMapper.update"/>
        where rh_account_number = #{rhAccountNumber}
        and df_scenario_uid = #{scenarioId}
    </update>

    <delete id="deleteByBatchId" parameterType="string">
        with usage_ids as (
            delete from ${schema}.df_usage
            where df_usage_batch_uid = #{batchId}
            returning df_usage_uid
        )
        delete from ${schema}.df_usage_aacl
        where df_usage_aacl_uid in (select df_usage_uid from usage_ids)
    </delete>

    <select id="findInvalidRightsholdersByFilter" parameterType="map" resultType="long">
        select distinct
            u.rh_account_number
        from ${schema}.df_usage u
        join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
        left join ${schema}.df_rightsholder r on u.rh_account_number = r.rh_account_number
        <include refid="IAaclUsageMapper.aaclUsageFilter"/>
            and r.df_rightsholder_uid is null
    </select>

    <sql id="selectDtoByScenarioIdSql">
        <include refid="IAaclUsageMapper.selectUsageDtos"/>
        where s.df_scenario_uid = #{scenarioId}
        order by u.rh_account_number, u.df_usage_uid
        <include refid="IUsageMapper.ifPageable"/>
    </sql>

    <update id="addToScenario" parameterType="map">
        update ${schema}.df_usage u
        set
            df_scenario_uid = #{scenarioId},
            status_ind = 'LOCKED',
            updated_by_user = #{updateUser},
            updated_datetime = now(),
            record_version = u.record_version + 1
        from ${schema}.df_usage_aacl uaacl
        <include refid="IAaclUsageMapper.aaclUsageFilter"/>
        and u.df_usage_uid = uaacl.df_usage_aacl_uid
    </update>

    <sql id="prepareCalculationSteps">
        with usage_weights as (
            select
                (usage_weight ->> 'period')::int as period,
                (usage_weight ->> 'weight')::decimal as weight
            from ${schema}.df_scenario sc, jsonb_array_elements(sc.aacl_fields -> 'usageAges') as usage_weight
            where df_scenario_uid = #{scenarioId}
        ),
        aggregate_mapping as (
            select
                (detailLicenseeClass ->> 'detailLicenseeClassId')::int as detailId,
                (detailLicenseeClass ->> 'aggregateLicenseeClassId')::int as aggregateId
            from ${schema}.df_scenario sc, jsonb_array_elements(sc.aacl_fields -> 'detailLicenseeClasses') as detailLicenseeClass
            where df_scenario_uid = #{scenarioId}
        ),
        weights as (
            select
                df_usage_uid,
                wr_wrk_inst,
                u.number_of_copies * (select weight from usage_weights where usage_period = period) * case when right_limitation != 'ALL' then 0.37 else 1 end volume_weight,
                u.number_of_copies * (select weight from usage_weights where usage_period = period) * ua.number_of_pages * publication_type_weight *  case when right_limitation != 'ALL' then 0.37 else 1 end value_weight,
                (select aggregateId from aggregate_mapping where detailId = ua.detail_licensee_class_id) aggregateId,
                u.df_scenario_uid
            from ${schema}.df_usage u
            join ${schema}.df_usage_aacl ua on u.df_usage_uid = ua.df_usage_aacl_uid
            join ${schema}.df_scenario sc on u.df_scenario_uid = sc.df_scenario_uid
            where u.df_scenario_uid = #{scenarioId}
        ),
        denominators as (
            select
                case when sum(volume_weight) != 0 then sum(volume_weight) else 1 end volume_denominator,
                case when sum(value_weight) != 0 then sum(value_weight) else 1 end value_denominator,
                aggregateId
            from weights
            group by aggregateId
        )
    </sql>

    <sql id="findByScenarioIdAndRhAccountNumberSql">
        select
            u.${detail_uid},
            u.product_family,
            u.wr_wrk_inst,
            u.system_title,
            u.standard_number,
            u.standard_number_type,
            u.gross_amount,
            u.service_fee_amount,
            u.net_amount,
            u.service_fee,
            ub.name batch_name,
            ub.payment_date batch_period_end_date,
            dlc.detail_licensee_class_id,
            dlc.discipline detail_licensee_discipline,
            dlc.enrollment_profile detail_licensee_enrollment,
            alc.aggregate_licensee_class_id,
            alc.discipline aggregate_licensee_discipline,
            alc.enrollment_profile aggregate_licensee_enrollment,
            pt.name pub_type_name,
            uaacl.publication_type_weight,
            uaacl.original_publication_type,
            uaacl.institution,
            uaacl.usage_period,
            uaacl.usage_source,
            uaacl.number_of_pages,
            uaacl.right_limitation,
            (usageAges ->> 'weight')::text usage_age_weight,
            u.number_of_copies,
            u.comment
        <include refid="IAaclUsageMapper.drillDownFromWhereClauses"/>
        order by
        <choose>
            <when test="null != sort">
                <include refid="IAaclUsageMapper.aaclChooseSortProperty"/>
            </when>
            <otherwise>
                u.${detail_uid}
            </otherwise>
        </choose>
        <include refid="IUsageMapper.ifPageable"/>
    </sql>

    <sql id="drillDownFromWhereClauses">
        from ${schema}.df_scenario s
        join ${schema}.${detail_table} u
            on s.df_scenario_uid = u.df_scenario_uid
        join ${schema}.df_usage_aacl uaacl
            on u.${detail_uid} = uaacl.df_usage_aacl_uid
        join ${schema}.df_usage_batch ub
            on ub.df_usage_batch_uid = u.df_usage_batch_uid
        left join ${schema}.df_publication_type pt
            on uaacl.df_publication_type_uid = pt.df_publication_type_uid
        left join ${schema}.df_detail_licensee_class dlc
            on uaacl.detail_licensee_class_id = dlc.detail_licensee_class_id
        left join jsonb_array_elements(s.aacl_fields -> 'usageAges') usageAges
            on (usageAges ->> 'period')::int = uaacl.usage_period
        left join jsonb_array_elements(s.aacl_fields -> 'detailLicenseeClasses') detailLicenseeClasses
            on (detailLicenseeClasses ->> 'detailLicenseeClassId')::int = dlc.detail_licensee_class_id
        left join ${schema}.df_aggregate_licensee_class alc
            on (detailLicenseeClasses ->> 'aggregateLicenseeClassId')::int = alc.aggregate_licensee_class_id
        where u.df_scenario_uid = #{scenarioId}
            and u.rh_account_number = #{accountNumber}
        <if test="null != searchValue">
            and (
                u.${detail_uid} like '%' || #{searchValue} || '%' or
                u.standard_number ilike '%' || #{searchValue} || '%' or
                cast(u.wr_wrk_inst as text) like '%' || #{searchValue} || '%'
            )
        </if>
    </sql>

    <select id="findWrWrkInstsUnderMinimum" resultType="long" parameterType="map">
        <include refid="prepareCalculationSteps"/>
        select
            wr_wrk_inst
        from weights
        join denominators on denominators.aggregateId = weights.aggregateId
        join ${schema}.df_scenario sc on weights.df_scenario_uid = sc.df_scenario_uid
        left join ${schema}.df_fund_pool_detail fpd on fpd.df_aggregate_licensee_class_id = weights.aggregateId
            and fpd.df_fund_pool_uid = sc.aacl_fields ->> 'fund_pool_uid'
        group by wr_wrk_inst
        having coalesce (sum((volume_weight / volume_denominator + value_weight / value_denominator) / 2 * fpd.gross_amount), 0) &lt; #{cutoffAmount}
    </select>

    <update id="updateAaclUsagesUnderMinimum" parameterType="map">
        update ${schema}.df_usage
        set
            status_ind = 'SCENARIO_EXCLUDED',
            df_scenario_uid = null,
            payee_account_number = null,
            <include refid="StoredEntityMapper.update"/>
        where df_scenario_uid = #{scenarioId}
            and wr_wrk_inst in
            <foreach collection="wrWrkInsts" item="wrWrkInst" separator="," open="(" close=")">
                #{wrWrkInst}
            </foreach>
    </update>

    <update id="calculateAmounts">
        <include refid="prepareCalculationSteps"/>,
        gross_amounts as (
            select
                df_usage_uid,
                coalesce ((volume_weight / volume_denominator + value_weight / value_denominator) / 2 * fpd.gross_amount, 0) as gross_amount
            from weights
            join denominators on denominators.aggregateId = weights.aggregateId
            join ${schema}.df_scenario sc on weights.df_scenario_uid = sc.df_scenario_uid
            left join ${schema}.df_fund_pool_detail fpd on fpd.df_aggregate_licensee_class_id = weights.aggregateId
                and fpd.df_fund_pool_uid = sc.aacl_fields ->> 'fund_pool_uid'
            where sc.df_scenario_uid = #{scenarioId}
        ),
        weights_update as (
            update ${schema}.df_usage_aacl ua
            set
                volume_weight = weights.volume_weight,
                value_weight = weights.value_weight,
                volume_share = weights.volume_weight / volume_denominator,
                value_share = weights.value_weight / value_denominator,
                total_share = (weights.volume_weight / volume_denominator + weights.value_weight / value_denominator) / 2,
                <include refid="StoredEntityMapper.update"/>
            from weights
            join denominators on denominators.aggregateId = weights.aggregateId
            where ua.df_usage_aacl_uid = weights.df_usage_uid
        )
        update ${schema}.df_usage u
        set
            gross_amount = ga.gross_amount,
            net_amount = ga.gross_amount * 0.75,
            service_fee_amount = ga.gross_amount * 0.25,
            service_fee = 0.25,
            <include refid="StoredEntityMapper.update"/>
        from gross_amounts ga
        where u.df_usage_uid = ga.df_usage_uid
    </update>

    <update id="updatePublicationTypeWeight" parameterType="map">
        update ${schema}.df_usage_aacl uaacl
        set
            publication_type_weight = #{weight},
            updated_by_user = #{updateUser},
            updated_datetime = now(),
            record_version = u.record_version + 1
        from ${schema}.df_usage u
        where uaacl.df_usage_aacl_uid = u.df_usage_uid
            and u.df_scenario_uid = #{scenarioId}
            and uaacl.df_publication_type_uid = #{publicationTypeId}
            and uaacl.baseline_uid is null
    </update>

    <select id="usagesExistByDetailLicenseeClassAndFilter" parameterType="map" resultType="boolean">
        select exists (
            select 1
            from ${schema}.df_usage u
            join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
            <include refid="IAaclUsageMapper.aaclUsageFilter"/>
                and uaacl.detail_licensee_class_id = #{detailLicenseeClassId}
                and u.df_scenario_uid is null
        )
    </select>

    <select id="findPayeeTotalHoldersByFilter" parameterType="map" resultMap="payeeTotalHolderResultMap">
        select
            u.payee_account_number,
            payee.name payee_name,
            sum(u.gross_amount) gross_total,
            sum(u.service_fee_amount) service_fee_total,
            sum(u.net_amount) net_total
        from ${schema}.df_usage u
        join ${schema}.df_rightsholder payee on u.payee_account_number = payee.rh_account_number
        join ${schema}.df_scenario s on u.df_scenario_uid = s.df_scenario_uid
        where u.df_scenario_uid in
            <foreach collection="filter.scenarioIds" item="scenarioId" open="(" separator="," close=")">
                #{scenarioId}
            </foreach>
        <if test="null != filter.searchValue">
            and
            (payee.name ilike '%' || #{filter.searchValue} || '%' or
            cast(u.payee_account_number as text) like '%' || #{filter.searchValue} || '%')
        </if>
        group by payee_account_number, payee.name
        <if test="null != filter.netAmountMinThreshold">
            having sum(u.net_amount) &lt; ${filter.netAmountMinThreshold}
        </if>
        order by payee.name asc
    </select>

    <select id="findCountByScenarioIdAndRhAccountNumber" parameterType="map" resultType="int">
        select count(1)
        <include refid="drillDownFromWhereClauses">
            <property name="detail_table" value="df_usage"/>
            <property name="detail_uid" value="df_usage_uid"/>
        </include>
    </select>

    <select id="findByScenarioIdAndRhAccountNumber" parameterType="map" resultMap="aaclUsageDtoResultMap">
        <include refid="IAaclUsageMapper.findByScenarioIdAndRhAccountNumberSql">
            <property name="detail_table" value="df_usage"/>
            <property name="detail_uid" value="df_usage_uid"/>
        </include>
    </select>

    <update id="deleteFromScenario" parameterType="map">
        with usage_ids as (
            update
                ${schema}.df_usage u
            set
                status_ind = #{updateStatusTo},
                df_scenario_uid = null,
                payee_account_number = null,
                service_fee = null,
                service_fee_amount = 0,
                net_amount = 0,
                gross_amount = 0,
                <include refid="StoredEntityMapper.update"/>
            where <include refid="IUsageMapper.scenarioBatchesFilter"/>
                and u.status_ind in
                    <foreach collection="updateStatusesFrom" item="updateStatusFrom" separator="," open="(" close=")">
                        #{updateStatusFrom}
                    </foreach>
            returning u.df_usage_uid
        )
        update ${schema}.df_usage_aacl
        set
            volume_weight = null,
            value_weight = null,
            volume_share = null,
            value_share = null,
            total_share = null,
            publication_type_weight = case when baseline_uid is null then null else publication_type_weight end,
            <include refid="StoredEntityMapper.update"/>
        from usage_ids
        where df_usage_aacl_uid = usage_ids.df_usage_uid
    </update>

    <update id="addToBaselineByScenarioId" parameterType="map">
        insert into ${schema}.df_usage_baseline_aacl (
            df_usage_baseline_aacl_uid,
            wr_wrk_inst,
            number_of_copies,
            comment,
            usage_period,
            usage_source,
            number_of_pages,
            detail_licensee_class_id,
            df_publication_type_uid,
            publication_type_weight,
            institution,
            <include refid="StoredEntityMapper.additionalColumns"/>
        )
        select
            uuid_generate_v4() df_usage_baseline_aacl_uid,
            u.wr_wrk_inst,
            u.number_of_copies,
            u.comment,
            uaacl.usage_period,
            uaacl.usage_source,
            uaacl.number_of_pages,
            uaacl.detail_licensee_class_id,
            uaacl.df_publication_type_uid,
            uaacl.publication_type_weight,
            uaacl.institution,
            <include refid="StoredEntityMapper.insert"/>
        from ${schema}.df_usage u
        join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
        where <include refid="IUsageMapper.scenarioBatchesFilter"/>
            and uaacl.baseline_uid is null
    </update>

    <select id="findBaselineUsages" parameterType="map" resultMap="aaclUsageResultMap">
        select
            uba.df_usage_baseline_aacl_uid df_usage_uid,
            uba.wr_wrk_inst,
            uba.number_of_copies,
            uba.comment,
            uba.usage_period,
            uba.usage_source,
            uba.number_of_pages,
            uba.detail_licensee_class_id,
            dlc.discipline detail_licensee_discipline,
            dlc.enrollment_profile detail_licensee_enrollment,
            uba.df_publication_type_uid pub_type_id,
            pt.name pub_type_name,
            uba.publication_type_weight,
            uba.original_publication_type,
            uba.institution
        from ${schema}.df_usage_baseline_aacl uba
        left join ${schema}.df_publication_type pt
            on uba.df_publication_type_uid = pt.df_publication_type_uid
        left join ${schema}.df_detail_licensee_class dlc
            on uba.detail_licensee_class_id = dlc.detail_licensee_class_id
    </select>

    <delete id="deleteLockedByScenarioId" parameterType="map">
        delete from ${schema}.df_usage
        where df_scenario_uid = #{scenarioId}
    </delete>

    <delete id="deleteExcludedByScenarioId" parameterType="map">
        with u as (
            delete from ${schema}.df_usage
            where <include refid="IUsageMapper.scenarioBatchesFilter"/> and status_ind = #{status}
            returning df_usage_uid
        )
        delete from ${schema}.df_usage_aacl
        where df_usage_aacl_uid in (select df_usage_uid from u)
    </delete>

    <select id="findPayeeAggClassesPairsByScenarioId" parameterType="string" resultMap="payeeAggLicenseeClassesPairResultMap">
        select
            payee_account_number,
            aggregate_licensee_class_id,
            discipline,
            enrollment_profile
        from ${schema}.df_usage u
        left join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
        left join ${schema}.df_detail_licensee_class dlc on uaacl.detail_licensee_class_id = dlc.detail_licensee_class_id
        where df_scenario_uid = #{scenarioId}
    </select>
</mapper>
