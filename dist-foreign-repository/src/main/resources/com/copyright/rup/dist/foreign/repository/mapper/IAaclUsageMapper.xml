<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="IAaclUsageMapper">

    <resultMap id="aaclUsageResultMap" type="Usage" extends="StoredEntityMapper.storedEntityResult">
        <result property="id" column="df_usage_uid"/>
        <result property="batchId" column="df_usage_batch_uid"/>
        <result property="status" column="status_ind"/>
        <result property="productFamily" column="product_family"/>
        <result property="wrWrkInst" column="wr_wrk_inst"/>
        <result property="rightsholder.id" column="rh_id"/>
        <result property="rightsholder.accountNumber" column="rh_account_number"/>
        <result property="rightsholder.name" column="rh_name"/>
        <result property="systemTitle" column="system_title"/>
        <result property="standardNumber" column="standard_number"/>
        <result property="standardNumberType" column="standard_number_type"/>
        <result property="numberOfCopies" column="number_of_copies"/>
        <result property="comment" column="comment"/>
        <result property="aaclUsage.institution" column="institution"/>
        <result property="aaclUsage.usagePeriod" column="usage_period"/>
        <result property="aaclUsage.usageSource" column="usage_source"/>
        <result property="aaclUsage.numberOfPages" column="number_of_pages"/>
        <result property="aaclUsage.rightLimitation" column="right_limitation"/>
        <result property="aaclUsage.batchPeriodEndDate" column="batch_period_end_date"/>
        <result property="aaclUsage.discipline" column="discipline"/>
        <result property="aaclUsage.enrollmentProfile" column="enrollment_profile"/>
        <result property="aaclUsage.publicationType" column="name"/>
        <result property="aaclUsage.detailLicenseeClassId" column="detail_licensee_class_id"/>
    </resultMap>

    <resultMap id="aaclUsageDtoResultMap" type="UsageDto" extends="StoredEntityMapper.storedEntityResult">
        <result property="id" column="df_usage_uid"/>
        <result property="batchName" column="batch_name"/>
        <result property="status" column="status_ind"/>
        <result property="productFamily" column="product_family"/>
        <result property="wrWrkInst" column="wr_wrk_inst"/>
        <result property="rhAccountNumber" column="rh_account_number"/>
        <result property="rhName" column="rh_name"/>
        <result property="systemTitle" column="system_title"/>
        <result property="standardNumber" column="standard_number"/>
        <result property="standardNumberType" column="standard_number_type"/>
        <result property="numberOfCopies" column="number_of_copies"/>
        <result property="comment" column="comment"/>
        <result property="aaclUsage.institution" column="institution"/>
        <result property="aaclUsage.usagePeriod" column="usage_period"/>
        <result property="aaclUsage.usageSource" column="usage_source"/>
        <result property="aaclUsage.numberOfPages" column="number_of_pages"/>
        <result property="aaclUsage.rightLimitation" column="right_limitation"/>
        <result property="aaclUsage.batchPeriodEndDate" column="batch_period_end_date"/>
        <result property="aaclUsage.discipline" column="discipline"/>
        <result property="aaclUsage.enrollmentProfile" column="enrollment_profile"/>
        <result property="aaclUsage.publicationType" column="name"/>
        <result property="aaclUsage.detailLicenseeClassId" column="detail_licensee_class_id"/>
    </resultMap>

    <sql id="aaclUsageColumns">
        u.df_usage_uid,
        u.df_usage_batch_uid,
        u.wr_wrk_inst,
        u.system_title,
        u.standard_number,
        u.standard_number_type,
        u.rh_account_number,
        rh.name rh_name,
        rh.df_rightsholder_uid rh_id,
        u.status_ind,
        u.product_family,
        u.number_of_copies,
        u.comment,
        ub.payment_date batch_period_end_date,
        uaacl.institution,
        uaacl.usage_period,
        uaacl.usage_source,
        uaacl.number_of_pages,
        uaacl.right_limitation,
        uaacl.detail_licensee_class_id,
        dlc.discipline,
        dlc.enrollment_profile,
        pt.name,
        u.created_datetime,
        u.updated_datetime,
        u.created_by_user,
        u.updated_by_user,
        u.record_version
    </sql>

    <sql id="aaclUsageFilter">
        <where>
            <if test="filter.usageBatchesIds.size() > 0">
                and
                <foreach collection="filter.usageBatchesIds" item="usageBatchId" open="(" separator=" or " close=")">
                    u.df_usage_batch_uid = #{usageBatchId}
                </foreach>
            </if>
            <if test="null != filter.productFamily">
                and u.product_family = #{filter.productFamily}
            </if>
            <if test="null != filter.usageStatus">
                and u.status_ind = #{filter.usageStatus}
            </if>
            <if test="null != filter.usagePeriod">
                and uaacl.usage_period = #{filter.usagePeriod}
            </if>
        </where>
    </sql>

    <sql id="aaclChooseSortProperty">
        <choose>
            <when test="sort.property == 'detailId'">
                ${detail_uid} <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'status'">
                u.status_ind <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'productFamily'">
                u.product_family <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'batchName'">
                ub.name <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'periodEndDate'">
                ub.payment_date <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'rhAccountNumber'">
                u.rh_account_number <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'rhName'">
                rh.name <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'wrWrkInst'">
                u.wr_wrk_inst <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'systemTitle'">
                u.system_title <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'standardNumber'">
                u.standard_number <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'standardNumberType'">
                u.standard_number_type <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'institution'">
                uaacl.institution <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'usagePeriod'">
                uaacl.usage_period <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'usageSource'">
                uaacl.usage_source <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'numberOfCopies'">
                u.number_of_copies <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'numberOfPages'">
                uaacl.number_of_pages <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'rightLimitation'">
                uaacl.right_limitation <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'comment'">
                u.comment <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'discipline'">
                dlc.discipline <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'enrollmentProfile'">
                dlc.enrollment_profile <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'publicationType'">
                pt.name <include refid="IUsageMapper.direction"/>
            </when>
            <when test="sort.property == 'detailLicenseeClassId'">
                uaacl.detail_licensee_class_id <include refid="IUsageMapper.direction"/>
            </when>
        </choose>
    </sql>

    <sql id="selectDtosByFilterSql">
        select
            <include refid="IAaclUsageMapper.aaclUsageColumns"/>,
            ub.name batch_name
        from ${schema}.df_usage u
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
        left join ${schema}.df_publication_type pt on uaacl.publication_type_uid = pt.df_publication_type_uid
        left join ${schema}.df_detail_licensee_class dlc on uaacl.detail_licensee_class_id = dlc.detail_licensee_class_id
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        <include refid="IAaclUsageMapper.aaclUsageFilter"/>
        order by
        <choose>
            <when test="null != sort">
                <include refid="IAaclUsageMapper.aaclChooseSortProperty">
                    <property name="detail_uid" value="u.df_usage_uid"/>
                </include>
            </when>
            <otherwise>
                updated_datetime desc
            </otherwise>
        </choose>,
        df_usage_uid
        <include refid="IUsageMapper.ifPageable"/>
    </sql>

    <select id="findDtosByFilter" resultMap="aaclUsageDtoResultMap" parameterType="map" fetchSize="${usageSelectFetchSize}">
        <include refid="IAaclUsageMapper.selectDtosByFilterSql"/>
    </select>

    <sql id="selectCountByFilterSql">
        select count(1)
        from ${schema}.df_usage u
        join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
        <include refid="IAaclUsageMapper.aaclUsageFilter"/>
    </sql>

    <select id="findCountByFilter" parameterType="map" resultType="int">
        <include refid="IAaclUsageMapper.selectCountByFilterSql"/>
    </select>

    <insert id="insert" parameterType="Usage">
        with u as (
            insert into ${schema}.df_usage (
                df_usage_uid,
                df_usage_batch_uid,
                wr_wrk_inst,
                system_title,
                standard_number,
                standard_number_type,
                rh_account_number,
                status_ind,
                product_family,
                number_of_copies,
                comment,
                <include refid="StoredEntityMapper.additionalColumns"/>
            )
            values (
                #{id},
                #{batchId},
                #{wrWrkInst},
                #{systemTitle},
                #{standardNumber},
                #{standardNumberType},
                #{rightsholder.accountNumber},
                #{status},
                #{productFamily},
                #{numberOfCopies},
                #{comment},
                <include refid="StoredEntityMapper.insert"/>
            )
        )
        insert into ${schema}.df_usage_aacl (
            df_usage_aacl_uid,
            institution,
            usage_period,
            usage_source,
            number_of_pages,
            right_limitation,
            <include refid="StoredEntityMapper.additionalColumns"/>
        )
        values (
            #{id},
            #{aaclUsage.institution},
            #{aaclUsage.usagePeriod},
            #{aaclUsage.usageSource},
            #{aaclUsage.numberOfPages},
            #{aaclUsage.rightLimitation},
            <include refid="StoredEntityMapper.insert"/>
        )
    </insert>

    <select id="updateProcessedUsage" parameterType="map" resultType="string">
        with u as (
            update ${schema}.df_usage_aacl
            set
                right_limitation = #{aaclUsage.rightLimitation},
                <include refid="StoredEntityMapper.update"/>
            where df_usage_aacl_uid = #{id}
        )
        update ${schema}.df_usage
        set
            status_ind = #{status},
            rh_account_number = #{rightsholder.accountNumber},
            system_title = #{systemTitle},
            standard_number = #{standardNumber},
            standard_number_type = #{standardNumberType},
            <include refid="StoredEntityMapper.update"/>
        where df_usage_uid = #{id}
            and record_version = #{version}
        returning df_usage_uid
    </select>

    <delete id="deleteById" parameterType="string">
        with u as (
            delete from ${schema}.df_usage
            where df_usage_uid = #{usageId}
        )
        delete from ${schema}.df_usage_aacl
        where df_usage_aacl_uid = #{usageId}
    </delete>

    <select id="findByIds" resultMap="aaclUsageResultMap">
        select
            <include refid="IAaclUsageMapper.aaclUsageColumns"/>
        from ${schema}.df_usage u
        join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
        join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
        left join ${schema}.df_publication_type pt on uaacl.publication_type_uid = pt.df_publication_type_uid
        left join ${schema}.df_detail_licensee_class dlc on uaacl.detail_licensee_class_id = dlc.detail_licensee_class_id
        left join ${schema}.df_rightsholder rh on rh.rh_account_number = u.rh_account_number
        where u.df_usage_uid in
        <foreach collection="list" item="usageId" open="(" separator="," close=")">
            #{usageId}
        </foreach>
        order by u.df_usage_uid
    </select>

    <select id="findReferencedAaclUsagesCountByIds" resultType="int" parameterType="list">
        select count(1)
        from ${schema}.df_usage_aacl
        where df_usage_aacl_uid in
        <foreach collection="usageIds" item="usageId" open="(" separator="," close=")">
            #{usageId}
        </foreach>
    </select>

    <select id="findUsagePeriods" resultType="int">
        select distinct usage_period
        from ${schema}.df_usage_aacl
        order by usage_period
    </select>

    <select id="isValidFilteredUsageStatus" parameterType="map" resultType="boolean">
        select not exists (
            select 1
            from ${schema}.df_usage u
            join ${schema}.df_usage_aacl uaacl on u.df_usage_uid = uaacl.df_usage_aacl_uid
            join ${schema}.df_usage_batch ub on u.df_usage_batch_uid = ub.df_usage_batch_uid
            <include refid="IAaclUsageMapper.aaclUsageFilter"/>
                and u.df_scenario_uid is null
                and u.status_ind != #{status}
        )
    </select>

    <update id="updateClassifiedUsage" parameterType="map">
        with u as (
            update ${schema}.df_usage
            set
                status_ind = #{status},
                wr_wrk_inst = #{aaclUsage.wrWrkInst},
                comment = #{aaclUsage.comment},
                <include refid="StoredEntityMapper.update"/>
            where df_usage_uid = #{aaclUsage.detailId}
        )
        update ${schema}.df_usage_aacl uaacl
        set
            detail_licensee_class_id = dlc.detail_licensee_class_id,
            publication_type_uid = pt.df_publication_type_uid,
            updated_by_user = #{updateUser},
            updated_datetime = now(),
            record_version = uaacl.record_version + 1
        from ${schema}.df_publication_type pt, ${schema}.df_detail_licensee_class dlc
        where df_usage_aacl_uid = #{aaclUsage.detailId}
            and pt.name ilike #{aaclUsage.publicationType}
            and dlc.enrollment_profile ilike #{aaclUsage.enrollmentProfile}
            and dlc.discipline ilike #{aaclUsage.discipline}
    </update>

    <delete id="deleteByBatchId" parameterType="string">
        with usage_ids as (
            delete from ${schema}.df_usage
            where df_usage_batch_uid = #{batchId}
            returning df_usage_uid
        )
        delete from ${schema}.df_usage_aacl
        where df_usage_aacl_uid in (select df_usage_uid from usage_ids)
    </delete>
</mapper>
